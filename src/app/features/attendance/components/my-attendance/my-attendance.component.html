<div class="bg-background min-h-screen">

  <!-- Success / Error alerts -->
  @if (success()) {
    <div class="bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg p-3 flex items-center gap-2 text-green-800 dark:text-green-300 mb-4 text-sm">
      <z-icon zType="circle-check" class="w-4 h-4 shrink-0" />
      <span>{{ success() }}</span>
    </div>
  }
  @if (error()) {
    <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg p-3 flex items-center gap-2 text-red-800 dark:text-red-300 mb-4 text-sm">
      <z-icon zType="triangle-alert" class="w-4 h-4 shrink-0" />
      <span>{{ error() }}</span>
    </div>
  }

  <!-- ═══════════════ CLOCK IN/OUT SECTION ═══════════════ -->
  <div z-card class="mb-6">
    <div z-card-content class="p-6">
      <div class="flex flex-col lg:flex-row lg:items-center gap-6">

        <!-- Left: Time display + button -->
        <div class="flex-1">
          <div class="mb-4">
            <div class="text-4xl font-bold text-foreground tracking-tight">
              {{ formatCurrentTime() }}
            </div>
            <div class="text-sm text-muted-foreground mt-1">
              {{ formatCurrentDate() }}
            </div>
          </div>

          <!-- Attendance type toggle -->
          <div class="flex gap-2 mb-4">
            <button z-button
              [zType]="attendanceType() === 'Office' ? 'default' : 'outline'"
              zSize="sm"
              class="gap-1.5"
              (click)="attendanceType.set('Office')"
              [disabled]="isClockedIn()">
              <z-icon [zType]="$any('map-pin')" class="w-3.5 h-3.5" />
              Office
            </button>
            <button z-button
              [zType]="attendanceType() === 'WFH' ? 'default' : 'outline'"
              zSize="sm"
              class="gap-1.5"
              (click)="attendanceType.set('WFH')"
              [disabled]="isClockedIn()">
              <z-icon [zType]="$any('house')" class="w-3.5 h-3.5" />
              WFH
            </button>
          </div>

          <!-- Location warning -->
          @if (attendanceType() === 'Office' && locationPermission() === 'denied') {
            <div class="bg-yellow-50 dark:bg-yellow-950/30 border border-yellow-200 dark:border-yellow-800 rounded-lg p-2.5 flex items-center gap-2 text-yellow-800 dark:text-yellow-300 mb-4 text-xs">
              <z-icon [zType]="$any('triangle-alert')" class="w-4 h-4 shrink-0" />
              <span>Location permission required for Office attendance.</span>
            </div>
          }

          <!-- Clock In / Out Button -->
          @if (!isClockedIn()) {
            <button z-button zSize="lg"
              class="w-full lg:w-auto gap-2 bg-green-600 hover:bg-green-700 text-white px-10"
              (click)="clockIn()"
              [disabled]="loading() || loadingLocation()">
              @if (loading() || loadingLocation()) {
                <z-icon [zType]="$any('loader-circle')" class="w-4 h-4 animate-spin" />
              } @else {
                <z-icon [zType]="$any('log-in')" class="w-4 h-4" />
              }
              {{ loadingLocation() ? 'Getting Location...' : 'Clock In' }}
            </button>
          } @else {
            <button z-button zSize="lg"
              class="w-full lg:w-auto gap-2 bg-red-600 hover:bg-red-700 text-white px-10"
              (click)="clockOut()"
              [disabled]="loading() || loadingLocation()">
              @if (loading() || loadingLocation()) {
                <z-icon [zType]="$any('loader-circle')" class="w-4 h-4 animate-spin" />
              } @else {
                <z-icon [zType]="$any('log-out')" class="w-4 h-4" />
              }
              {{ loadingLocation() ? 'Getting Location...' : 'Clock Out' }}
            </button>
          }
        </div>

        <!-- Right: Today's summary -->
        <div class="lg:w-72 bg-muted/30 rounded-xl p-5">
          <h4 class="text-xs font-semibold uppercase tracking-wider text-muted-foreground mb-3">Today's Status</h4>

          <div class="mb-3">
            <z-badge [zType]="getStatusBadgeType()" zShape="pill" class="text-xs">
              {{ getStatusText() }}
            </z-badge>
          </div>

          <div class="space-y-2.5 text-sm">
            <div class="flex items-center justify-between">
              <span class="text-muted-foreground flex items-center gap-1.5">
                <z-icon [zType]="$any('log-in')" class="w-3.5 h-3.5" />
                Clock In
              </span>
              <span class="font-medium" [class.text-green-600]="clockInTime()">{{ formatTime(clockInTime()) }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-muted-foreground flex items-center gap-1.5">
                <z-icon [zType]="$any('log-out')" class="w-3.5 h-3.5" />
                Clock Out
              </span>
              <span class="font-medium" [class.text-red-600]="clockOutTime()">{{ formatTime(clockOutTime()) }}</span>
            </div>
            <div class="border-t pt-2.5 flex items-center justify-between">
              <span class="text-muted-foreground flex items-center gap-1.5">
                <z-icon [zType]="$any('clock')" class="w-3.5 h-3.5" />
                Total Hours
              </span>
              <span class="font-semibold text-foreground">{{ totalHours() > 0 ? formatHours(totalHours()) : '--' }}</span>
            </div>
            @if (todayAttendance()) {
              <div class="flex items-center justify-between">
                <span class="text-muted-foreground flex items-center gap-1.5">
                  <z-icon [zType]="$any(todayAttendance()!.type === 'WFH' ? 'house' : 'map-pin')" class="w-3.5 h-3.5" />
                  Type
                </span>
                <z-badge zType="secondary" zShape="pill" class="text-xs">{{ todayAttendance()!.type }}</z-badge>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════ TAB NAVIGATION ═══════════════ -->
  <div class="flex items-center gap-1 mb-4 border-b">
    <button
      class="px-4 py-2.5 text-sm font-medium transition-colors relative"
      [class]="activeTab() === 'history'
        ? 'text-foreground border-b-2 border-primary -mb-px'
        : 'text-muted-foreground hover:text-foreground'"
      (click)="switchTab('history')">
      <span class="flex items-center gap-1.5">
        <z-icon [zType]="$any('calendar')" class="w-4 h-4" />
        History
      </span>
    </button>
    <button
      class="px-4 py-2.5 text-sm font-medium transition-colors relative"
      [class]="activeTab() === 'wfh'
        ? 'text-foreground border-b-2 border-primary -mb-px'
        : 'text-muted-foreground hover:text-foreground'"
      (click)="switchTab('wfh')">
      <span class="flex items-center gap-1.5">
        <z-icon [zType]="$any('house')" class="w-4 h-4" />
        WFH Application
      </span>
    </button>
  </div>

  <!-- ═══════════════ HISTORY TAB ═══════════════ -->
  @if (activeTab() === 'history') {
    <div z-card>
      <div z-card-content class="p-5">
        <!-- Month Navigator -->
        <div class="flex items-center justify-between mb-4">
          <button z-button zType="outline" zSize="sm" (click)="prevMonth()" class="gap-1">
            <z-icon [zType]="$any('chevron-left')" class="w-4 h-4" />
          </button>
          <span class="text-sm font-semibold text-foreground">{{ currentMonthLabel() }}</span>
          <button z-button zType="outline" zSize="sm" (click)="nextMonth()"
            [disabled]="isCurrentMonth()" class="gap-1">
            <z-icon [zType]="$any('chevron-right')" class="w-4 h-4" />
          </button>
        </div>

        <!-- Loading -->
        @if (loadingHistory()) {
          <div class="flex flex-col items-center justify-center py-12">
            <z-icon [zType]="$any('loader-circle')" class="w-6 h-6 animate-spin text-primary mb-2" />
            <p class="text-sm text-muted-foreground">Loading attendance records...</p>
          </div>
        }

        <!-- Attendance Table -->
        @if (!loadingHistory() && attendances().length > 0) {
          <div class="bg-card border rounded-lg overflow-hidden">
            <table class="w-full text-sm">
              <thead class="bg-muted/30 border-b">
                <tr>
                  <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Date</th>
                  <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Clock In</th>
                  <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Clock Out</th>
                  <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Hours</th>
                  <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Type</th>
                  <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y">
                @for (a of attendances(); track a.id) {
                  <tr class="hover:bg-muted/20 transition-colors">
                    <td class="px-3 py-2.5 font-medium text-foreground whitespace-nowrap">
                      {{ formatDate(a.clock_in_time || a.created_at) }}
                    </td>
                    <td class="px-3 py-2.5 text-foreground whitespace-nowrap">
                      {{ formatTime(a.clock_in_time) }}
                    </td>
                    <td class="px-3 py-2.5 text-foreground whitespace-nowrap">
                      {{ formatTime(a.clock_out_time || null) }}
                    </td>
                    <td class="px-3 py-2.5 text-foreground whitespace-nowrap">
                      {{ a.total_hours ? formatHours(a.total_hours) : '--' }}
                    </td>
                    <td class="px-3 py-2.5">
                      <z-badge zType="secondary" zShape="pill" class="text-xs">{{ a.type }}</z-badge>
                    </td>
                    <td class="px-3 py-2.5">
                      <z-badge [zType]="getAttendanceStatusBadgeType(a)" zShape="pill" class="text-xs">
                        {{ getAttendanceStatusText(a) }}
                      </z-badge>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          @if (historyTotalPages() > 1) {
            <div class="flex items-center justify-center gap-2 mt-4">
              <button z-button zType="outline" zSize="sm"
                (click)="onHistoryPageChange(historyPage() - 1)"
                [disabled]="historyPage() === 1">
                <z-icon [zType]="$any('chevron-left')" class="w-4 h-4" />
              </button>
              <span class="text-xs text-muted-foreground px-2">
                {{ historyPage() }} / {{ historyTotalPages() }}
              </span>
              <button z-button zType="outline" zSize="sm"
                (click)="onHistoryPageChange(historyPage() + 1)"
                [disabled]="historyPage() === historyTotalPages()">
                <z-icon [zType]="$any('chevron-right')" class="w-4 h-4" />
              </button>
            </div>
          }
        }

        <!-- Empty State -->
        @if (!loadingHistory() && attendances().length === 0) {
          <div class="flex flex-col items-center justify-center py-12 text-center">
            <z-icon [zType]="$any('calendar-x')" class="w-10 h-10 text-muted-foreground mb-3" />
            <h3 class="text-sm font-semibold mb-1">No records found</h3>
            <p class="text-xs text-muted-foreground">No attendance records for {{ currentMonthLabel() }}</p>
          </div>
        }
      </div>
    </div>
  }

  <!-- ═══════════════ WFH TAB ═══════════════ -->
  @if (activeTab() === 'wfh') {
    <!-- WFH alerts -->
    @if (wfhSuccess()) {
      <div class="bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg p-3 flex items-center gap-2 text-green-800 dark:text-green-300 mb-4 text-sm">
        <z-icon zType="circle-check" class="w-4 h-4 shrink-0" />
        <span>{{ wfhSuccess() }}</span>
      </div>
    }
    @if (wfhError()) {
      <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg p-3 flex items-center gap-2 text-red-800 dark:text-red-300 mb-4 text-sm">
        <z-icon zType="triangle-alert" class="w-4 h-4 shrink-0" />
        <span>{{ wfhError() }}</span>
      </div>
    }

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Left: Application Form -->
      <div class="lg:col-span-4">
        <div z-card>
          <div z-card-content class="p-5">
            <h3 class="text-base font-semibold text-foreground mb-4 flex items-center gap-2">
              <z-icon [zType]="$any('plus')" class="w-4 h-4" />
              New Application
            </h3>

            <form [formGroup]="wfhForm" (ngSubmit)="onWfhSubmit()">
              <!-- Date -->
              <div class="mb-4">
                <label class="block text-sm font-medium text-foreground mb-1.5">
                  WFH Date <span class="text-red-500">*</span>
                </label>
                <z-date-picker
                  formControlName="date"
                  placeholder="Pick a date"
                  zFormat="dd-MM-yyyy"
                  zSize="sm"
                  [minDate]="getMinDate()"
                  [maxDate]="getMaxDate()">
                </z-date-picker>
                <p class="text-xs text-muted-foreground mt-1">At least 1 day in advance</p>
                @if (isFieldInvalid('date')) {
                  <p class="text-xs text-red-600 mt-1">{{ getFieldError('date') }}</p>
                }
              </div>

              <!-- Reason -->
              <div class="mb-4">
                <label for="reason" class="block text-sm font-medium text-foreground mb-1.5">
                  Reason <span class="text-red-500">*</span>
                </label>
                <textarea
                  id="reason"
                  class="w-full px-3 py-2 text-sm border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-background"
                  [class.border-red-500]="isFieldInvalid('reason')"
                  formControlName="reason"
                  rows="3"
                  placeholder="Reason for WFH application..."></textarea>
                <p class="text-xs text-muted-foreground mt-1">Min. 10 characters</p>
                @if (isFieldInvalid('reason')) {
                  <p class="text-xs text-red-600 mt-1">{{ getFieldError('reason') }}</p>
                }
              </div>

              <!-- Actions -->
              <div class="flex items-center gap-2">
                <button z-button zType="outline" zSize="sm" type="button"
                  (click)="wfhForm.reset()" [disabled]="submittingWfh()" class="flex-1">
                  Clear
                </button>
                <button z-button zType="default" zSize="sm" type="submit"
                  class="gap-2 flex-1" [disabled]="wfhForm.invalid || submittingWfh()">
                  @if (submittingWfh()) {
                    <z-icon [zType]="$any('loader-circle')" class="w-3.5 h-3.5 animate-spin" />
                  } @else {
                    <z-icon [zType]="$any('send')" class="w-3.5 h-3.5" />
                  }
                  Submit
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Right: Applications List -->
      <div class="lg:col-span-8">
        <div z-card>
          <div z-card-content class="p-5">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-base font-semibold text-foreground flex items-center gap-2">
                <z-icon [zType]="$any('file-text')" class="w-4 h-4" />
                My Applications
              </h3>

              <!-- Status filter -->
              <div z-menu [zMenuTriggerFor]="wfhStatusMenu">
                <button z-button zType="outline" zSize="sm" class="gap-2">
                  <z-icon [zType]="$any('list-filter')" class="w-3.5 h-3.5" />
                  @if (wfhStatusFilter()) {
                    {{ wfhStatusFilter() }}
                  } @else {
                    All
                  }
                </button>
              </div>
              <ng-template #wfhStatusMenu>
                <div z-menu-content class="w-40">
                  <button type="button" z-menu-item (click)="wfhStatusFilter.set(''); onWfhFilterChange()">All Status</button>
                  <button type="button" z-menu-item (click)="wfhStatusFilter.set('Pending'); onWfhFilterChange()">Pending</button>
                  <button type="button" z-menu-item (click)="wfhStatusFilter.set('Approved'); onWfhFilterChange()">Approved</button>
                  <button type="button" z-menu-item (click)="wfhStatusFilter.set('Rejected'); onWfhFilterChange()">Rejected</button>
                </div>
              </ng-template>
            </div>

            <!-- Loading -->
            @if (loadingWfh()) {
              <div class="flex flex-col items-center justify-center py-12">
                <z-icon [zType]="$any('loader-circle')" class="w-6 h-6 animate-spin text-primary mb-2" />
                <p class="text-sm text-muted-foreground">Loading...</p>
              </div>
            }

            <!-- WFH Table -->
            @if (!loadingWfh() && wfhApplications().length > 0) {
              <div class="bg-card border rounded-lg overflow-hidden">
                <table class="w-full text-sm">
                  <thead class="bg-muted/30 border-b">
                    <tr>
                      <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Date</th>
                      <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Reason</th>
                      <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Status</th>
                      <th class="text-left px-3 py-2.5 font-semibold text-muted-foreground">Approver</th>
                      <th class="w-16 px-3 py-2.5"></th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    @for (app of wfhApplications(); track app.id) {
                      <tr class="hover:bg-muted/20 transition-colors">
                        <td class="px-3 py-2.5 font-medium text-foreground whitespace-nowrap">
                          {{ formatWfhDate(app.date) }}
                        </td>
                        <td class="px-3 py-2.5 text-foreground max-w-[200px]">
                          <div class="line-clamp-1" [title]="app.reason">{{ app.reason }}</div>
                        </td>
                        <td class="px-3 py-2.5">
                          <z-badge
                            [zType]="app.status === 'Approved' ? 'default' : app.status === 'Rejected' ? 'destructive' : 'secondary'"
                            zShape="pill"
                            class="text-xs">
                            {{ app.status }}
                          </z-badge>
                          @if (app.rejection_reason) {
                            <p class="text-xs text-red-500 mt-1 line-clamp-1" [title]="app.rejection_reason">
                              {{ app.rejection_reason }}
                            </p>
                          }
                        </td>
                        <td class="px-3 py-2.5 text-foreground">
                          {{ app.approver_name || app.approver?.email || '--' }}
                        </td>
                        <td class="px-3 py-2.5">
                          @if (canCancelWfh(app)) {
                            <button z-button zType="ghost" zSize="sm"
                              (click)="cancelWfhApplication(app.id)"
                              class="text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/30">
                              <z-icon [zType]="$any('x')" class="w-4 h-4" />
                            </button>
                          }
                        </td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>

              <!-- Pagination -->
              @if (wfhTotalPages() > 1) {
                <div class="flex items-center justify-center gap-2 mt-4">
                  <button z-button zType="outline" zSize="sm"
                    (click)="onWfhPageChange(wfhPage() - 1)"
                    [disabled]="wfhPage() === 1">
                    <z-icon [zType]="$any('chevron-left')" class="w-4 h-4" />
                  </button>
                  <span class="text-xs text-muted-foreground px-2">
                    {{ wfhPage() }} / {{ wfhTotalPages() }}
                  </span>
                  <button z-button zType="outline" zSize="sm"
                    (click)="onWfhPageChange(wfhPage() + 1)"
                    [disabled]="wfhPage() === wfhTotalPages()">
                    <z-icon [zType]="$any('chevron-right')" class="w-4 h-4" />
                  </button>
                </div>
              }
            }

            <!-- Empty State -->
            @if (!loadingWfh() && wfhApplications().length === 0) {
              <div class="flex flex-col items-center justify-center py-12 text-center">
                <z-icon [zType]="$any('inbox')" class="w-10 h-10 text-muted-foreground mb-3" />
                <h3 class="text-sm font-semibold mb-1">No applications found</h3>
                <p class="text-xs text-muted-foreground">Submit your first WFH application</p>
              </div>
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>
