<div class="bg-background min-h-screen">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-foreground">WFH Approvals</h1>
      <p class="text-muted-foreground">Review and manage Work From Home requests</p>
    </div>
    <button z-button zType="outline" routerLink="/attendance/wfh" class="gap-2">
      <z-icon zType="arrow-left" class="w-4 h-4" />
      Back to WFH
    </button>
  </div>

  <!-- Alerts -->
  @if (success()) {
    <div class="bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg p-3 flex items-center gap-2 text-green-800 dark:text-green-300 mb-4 text-sm">
      <z-icon zType="circle-check" class="w-4 h-4 shrink-0" />
      <span>{{ success() }}</span>
    </div>
  }
  @if (error()) {
    <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg p-3 flex items-center gap-2 text-red-800 dark:text-red-300 mb-4 text-sm">
      <z-icon zType="triangle-alert" class="w-4 h-4 shrink-0" />
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Filters -->
  <div class="flex items-center gap-3 mb-6 flex-wrap justify-between">
    <div class="flex items-center gap-3 flex-1 flex-wrap">
      <!-- Search -->
      <div class="relative max-w-xs">
        <z-icon zType="search" class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
        <input
          type="text"
          placeholder="Search employee..."
          class="pl-9 pr-3 h-9 w-full text-sm border rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-primary"
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event)"
          (input)="onSearchChange()" />
      </div>

      <!-- Status Filter -->
      <div z-menu [zMenuTriggerFor]="statusMenu">
        <button
          z-button
          zType="outline"
          [class]="selectedStatus()
            ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
            : 'gap-2 border border-dashed px-2'">
          <z-icon [zType]="selectedStatus() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
          {{ getStatusDisplayName() }}
        </button>
      </div>
      <ng-template #statusMenu>
        <div z-menu-content class="w-48">
          <button type="button" z-menu-item (click)="selectedStatus.set(''); onFilterChange()">
            All Status
          </button>
          <button type="button" z-menu-item (click)="selectedStatus.set('Pending'); onFilterChange()">
            Pending
          </button>
          <button type="button" z-menu-item (click)="selectedStatus.set('Approved'); onFilterChange()">
            Approved
          </button>
          <button type="button" z-menu-item (click)="selectedStatus.set('Rejected'); onFilterChange()">
            Rejected
          </button>
        </div>
      </ng-template>

      <!-- Clear Filters -->
      @if (selectedStatus() || searchQuery()) {
        <button
          type="button"
          z-button
          zType="outline"
          class="gap-2 border-none shadow-none px-2"
          (click)="selectedStatus.set('Pending'); searchQuery.set(''); onFilterChange()">
          Reset
          <z-icon zType="x" class="w-4 h-4" />
        </button>
      }
    </div>

    <!-- Records count -->
    <div class="text-sm text-muted-foreground">
      {{ totalRecords() }} application{{ totalRecords() !== 1 ? 's' : '' }}
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="flex items-center justify-center py-20">
      <z-icon zType="loader-circle" class="w-8 h-8 animate-spin text-primary" />
    </div>
  }

  <!-- Error State -->
  @if (!loading() && error()) {
    <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg p-4 flex items-center gap-2 text-red-800 dark:text-red-300 mb-6">
      <z-icon zType="triangle-alert" class="w-5 h-5" />
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Table -->
  @if (!loading()) {
    @if (wfhApplications().length > 0) {
      <div class="rounded-lg border">
        <table z-table>
          <thead>
            <tr>
              <th class="!pl-3">Employee</th>
              <th>WFH Date</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Responded</th>
              <th class="!pr-3 text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (app of wfhApplications(); track app.id) {
              <tr>
                <!-- Employee -->
                <td class="!pl-3">
                  <div class="flex items-center gap-3">
                    <z-avatar
                      [zFallback]="getEmployeeInitial(app)"
                      class="w-9 h-9" />
                    <div class="flex flex-col">
                      <span class="font-medium text-foreground text-sm">{{ app.employee?.full_name || 'Unknown' }}</span>
                      <span class="text-xs text-muted-foreground">{{ app.employee?.employee_code || 'N/A' }}</span>
                    </div>
                  </div>
                </td>

                <!-- Date -->
                <td class="whitespace-nowrap text-sm">
                  {{ formatDate(app.date) }}
                </td>

                <!-- Reason -->
                <td>
                  <div class="max-w-[250px] text-sm line-clamp-2" [title]="app.reason">
                    {{ app.reason }}
                  </div>
                </td>

                <!-- Status -->
                <td>
                  <z-badge
                    [zType]="app.status === 'Approved' ? 'default' : app.status === 'Rejected' ? 'destructive' : 'secondary'"
                    zShape="pill"
                    class="text-xs">
                    {{ app.status }}
                  </z-badge>
                  @if (app.approved_at) {
                    <div class="text-xs text-muted-foreground mt-1">{{ formatDateTime(app.approved_at) }}</div>
                  }
                </td>

                <!-- Responded At / Rejection Reason -->
                <td class="text-sm">
                  @if (app.status === 'Rejected' && app.rejection_reason) {
                    <div class="max-w-[200px]">
                      <span class="text-xs text-red-500 line-clamp-2" [title]="app.rejection_reason">{{ app.rejection_reason }}</span>
                    </div>
                  } @else if (app.approver_name) {
                    <span class="text-muted-foreground">{{ app.approver_name }}</span>
                  } @else {
                    <span class="text-muted-foreground">--</span>
                  }
                </td>

                <!-- Actions -->
                <td class="!pr-3 text-right">
                  @if (canApproveReject(app)) {
                    <div class="flex gap-1.5 justify-end">
                      <button
                        z-button
                        zType="outline"
                        zSize="sm"
                        [zTooltip]="'Approve'"
                        (click)="approveApplication(app.id)"
                        class="text-green-600 hover:text-green-700 hover:bg-green-50 dark:hover:bg-green-950/30 border-green-200 dark:border-green-800">
                        <z-icon zType="check" class="w-4 h-4" />
                      </button>
                      <button
                        z-button
                        zType="outline"
                        zSize="sm"
                        [zTooltip]="'Reject'"
                        (click)="openRejectionModal(app.id)"
                        class="text-red-600 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-950/30 border-red-200 dark:border-red-800">
                        <z-icon zType="x" class="w-4 h-4" />
                      </button>
                    </div>
                  } @else {
                    <z-badge zType="outline" class="text-xs">
                      {{ isPastDate(app.date) ? 'Past Date' : 'Processed' }}
                    </z-badge>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="flex items-center justify-between mt-4">
          <div class="text-sm text-muted-foreground">
            Showing {{ (currentPage() - 1) * limit + 1 }} to
            {{ Math.min(currentPage() * limit, totalRecords()) }} of
            {{ totalRecords() }} records
          </div>
          <div class="flex items-center gap-1">
            <button
              z-button
              zType="outline"
              zSize="sm"
              (click)="onPageChange(currentPage() - 1)"
              [disabled]="currentPage() === 1">
              Previous
            </button>
            @for (page of [].constructor(Math.min(totalPages(), 5)); track $index) {
              <button
                z-button
                [zType]="currentPage() === $index + 1 ? 'default' : 'outline'"
                zSize="sm"
                (click)="onPageChange($index + 1)"
                class="min-w-[36px]">
                {{ $index + 1 }}
              </button>
            }
            <button
              z-button
              zType="outline"
              zSize="sm"
              (click)="onPageChange(currentPage() + 1)"
              [disabled]="currentPage() === totalPages()">
              Next
            </button>
          </div>
        </div>
      }
    } @else {
      <!-- Empty State -->
      <div class="bg-card border rounded-lg">
        <div class="flex flex-col items-center justify-center py-20 text-center">
          <z-icon zType="inbox" class="w-16 h-16 text-muted-foreground mb-4" />
          <h3 class="text-lg font-semibold mb-2">No WFH Applications Found</h3>
          <p class="text-muted-foreground">There are no applications matching your filters</p>
        </div>
      </div>
    }
  }
</div>

<!-- Rejection Modal -->
@if (showRejectionModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" (click)="closeRejectionModal()"></div>

    <!-- Modal Content -->
    <div class="relative z-10 w-full max-w-md mx-4 bg-background border rounded-xl shadow-2xl">
      <!-- Header -->
      <div class="flex items-center justify-between p-5 border-b">
        <div>
          <h3 class="text-lg font-semibold text-foreground">Reject Application</h3>
          <p class="text-sm text-muted-foreground mt-0.5">Provide a reason for the rejection</p>
        </div>
        <button
          z-button
          zType="ghost"
          zSize="sm"
          (click)="closeRejectionModal()">
          <z-icon zType="x" class="w-4 h-4" />
        </button>
      </div>

      <!-- Body -->
      <div class="p-5">
        <label class="block text-sm font-medium text-foreground mb-1.5">
          Rejection Reason <span class="text-red-500">*</span>
        </label>
        <textarea
          class="w-full px-3 py-2 text-sm border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-primary"
          rows="4"
          [ngModel]="rejectionReason()"
          (ngModelChange)="rejectionReason.set($event)"
          placeholder="Please provide a reason for rejecting this application..."></textarea>
        <p class="text-xs text-muted-foreground mt-1.5">This reason will be shared with the employee.</p>
      </div>

      <!-- Footer -->
      <div class="flex items-center justify-end gap-2 p-5 border-t">
        <button
          z-button
          zType="outline"
          (click)="closeRejectionModal()">
          Cancel
        </button>
        <button
          z-button
          zType="destructive"
          class="gap-2"
          (click)="submitRejection()"
          [disabled]="!rejectionReason().trim()">
          <z-icon zType="x" class="w-4 h-4" />
          Reject Application
        </button>
      </div>
    </div>
  </div>
}
