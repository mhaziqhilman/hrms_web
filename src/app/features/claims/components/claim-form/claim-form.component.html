<div class="bg-background min-h-screen">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-foreground">
        {{ isEditMode() ? 'Edit Claim' : 'Submit New Claim' }}
      </h1>
      <p class="text-muted-foreground">
        {{ isEditMode() ? 'Update your expense claim details' : 'Submit your expense claim for approval' }}
      </p>
    </div>
    <button z-button zType="outline" routerLink="/claims" class="gap-2">
      <z-icon zType="arrow-left" class="w-4 h-4" />
      Back to Claims
    </button>
  </div>

  <!-- Error Message -->
  @if (error()) {
  <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-2 text-red-800 mb-6">
    <z-icon zType="triangle-alert" class="w-5 h-5" />
    <span>{{ error() }}</span>
  </div>
  }

  <!-- Success Message -->
  @if (success()) {
  <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-2 text-green-800 mb-6">
    <z-icon zType="circle-check" class="w-5 h-5" />
    <span>{{ success() }}</span>
  </div>
  }

  <!-- Loading Spinner -->
  @if (loading()) {
  <div class="flex items-center justify-center py-20">
    <z-icon zType="loader-circle" class="w-8 h-8 animate-spin text-primary" />
  </div>
  }

  <!-- Form -->
  @if (!loading()) {
  <form [formGroup]="claimForm" (ngSubmit)="onSubmit()">
    <!-- Masonry Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <!-- Left Column: Claim Information & Details -->
      <div class="lg:col-span-1 space-y-4">
        <!-- Claim Information Card -->
        <z-card class="hover:shadow-md transition-shadow">
          <div z-card-content class="p-5">
            <div class="flex items-center gap-2 mb-4">
              <z-icon zType="receipt-text" class="w-5 h-5 text-primary" />
              <h3 class="text-lg font-semibold text-foreground">Claim Information</h3>
            </div>

            <div class="space-y-4">
              <!-- Claim Type -->
              <div>
                <label class="block text-sm font-medium text-foreground mb-2">
                  Claim Type <span class="text-red-500">*</span>
                </label>
                <z-select zPlaceholder="Select claim type" formControlName="claim_type_id">
                  @for (type of claimTypes(); track type.id) {
                  <z-select-item [zValue]="type.id.toString()">
                    {{ type.name }}
                  </z-select-item>
                  }
                </z-select>
                @if (isFieldInvalid('claim_type_id')) {
                <p class="text-xs text-red-600 mt-1">{{ getFieldError('claim_type_id') }}</p>
                }
                @if (selectedClaimType()?.description) {
                <p class="text-xs text-muted-foreground mt-1">{{ selectedClaimType()?.description }}</p>
                }
              </div>

              <!-- Claim Type Info Alert -->
              @if (selectedClaimType()) {
              <div class="rounded-lg border border-border bg-background p-4">
                <div class="flex items-start gap-3">
                  <z-icon zType="info" class="w-5 h-5 text-primary mt-0.5" />
                  <div class="flex-1 space-y-2">
                    <div class="flex justify-between items-start">
                      <span class="text-sm font-medium text-foreground">Maximum Amount:</span>
                      <span class="text-sm font-semibold text-primary">
                        {{ formatCurrency(selectedClaimType()?.max_amount) }}
                      </span>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-sm font-medium text-foreground">Receipt Required:</span>
                      <z-badge [zType]="isReceiptRequired() ? 'destructive' : 'secondary'" class="text-xs">
                        {{ isReceiptRequired() ? 'Yes' : 'No' }}
                      </z-badge>
                    </div>
                  </div>
                </div>
              </div>
              }

              <div class="pt-2 border-t border-border">
                <h4 class="text-sm font-semibold text-foreground mb-3">Date & Amount</h4>

                <div class="space-y-4">
                  <!-- Expense Date -->
                  <div>
                    <label class="block text-sm font-medium text-foreground mb-2">
                      Expense Date <span class="text-red-500">*</span>
                    </label>
                    <z-date-picker placeholder="Select expense date" formControlName="date">
                    </z-date-picker>
                    @if (isFieldInvalid('date')) {
                    <p class="text-xs text-red-600 mt-1">{{ getFieldError('date') }}</p>
                    }
                    <p class="text-xs text-muted-foreground mt-1">Claims can be submitted up to 90 days in the past</p>
                  </div>

                  <!-- Amount -->
                  <div>
                    <label class="block text-sm font-medium text-foreground mb-2">
                      Amount (RM) <span class="text-red-500">*</span>
                    </label>
                    <input z-input type="number"
                      [zStatus]="isFieldInvalid('amount') || isAmountExceedingLimit() ? 'error' : undefined"
                      formControlName="amount" step="0.01" min="0.01" placeholder="0.00"
                      [disabled]="!isClaimEditable()">
                    @if (isFieldInvalid('amount')) {
                    <p class="text-xs text-red-600 mt-1">{{ getFieldError('amount') }}</p>
                    }
                    @if (!isFieldInvalid('amount') && isAmountExceedingLimit()) {
                    <p class="text-xs text-red-600 mt-1">
                      Amount exceeds maximum limit of {{ formatCurrency(selectedClaimType()?.max_amount) }}
                    </p>
                    }
                    @if (selectedClaimType()?.max_amount && !isAmountExceedingLimit()) {
                    <p class="text-xs text-muted-foreground mt-1">
                      Maximum allowed: {{ formatCurrency(selectedClaimType()?.max_amount) }}
                    </p>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </z-card>

        <!-- Details & Receipt Card -->
        <z-card class="hover:shadow-md transition-shadow">
          <div z-card-content class="p-5">
            <div class="flex items-center gap-2 mb-4">
              <z-icon zType="file-text" class="w-5 h-5 text-primary" />
              <h3 class="text-lg font-semibold text-foreground">Details & Receipt</h3>
            </div>

            <div class="space-y-4">
              <!-- Description -->
              <div>
                <label class="block text-sm font-medium text-foreground mb-2">
                  Description <span class="text-red-500">*</span>
                </label>
                <textarea z-input [zStatus]="isFieldInvalid('description') ? 'error' : undefined"
                  formControlName="description" rows="4" class="!h-auto resize-none"
                  placeholder="Provide details about this expense (minimum 10 characters)..."
                  [disabled]="!isClaimEditable()"></textarea>
                @if (isFieldInvalid('description')) {
                <p class="text-xs text-red-600 mt-1">{{ getFieldError('description') }}</p>
                }
                <p class="text-xs text-muted-foreground mt-1">Describe the purpose and details of this expense claim</p>
              </div>

              <!-- Receipt URL -->
              <div class="pt-2 border-t border-border">
                <div class="flex items-center justify-between mb-3">
                  <label class="block text-sm font-medium text-foreground">
                    Receipt URL @if (isReceiptRequired()) {<span class="text-red-500">*</span>} @else {(Optional)}
                  </label>
                  @if (isReceiptRequired()) {
                  <z-badge zType="destructive" class="text-xs">Required</z-badge>
                  } @else {
                  <z-badge zType="secondary" class="text-xs">Optional</z-badge>
                  }
                </div>

                <input z-input type="url" [zStatus]="isFieldInvalid('receipt_url') ? 'error' : undefined"
                  formControlName="receipt_url" placeholder="https://example.com/receipt.jpg"
                  [disabled]="!isClaimEditable()">
                @if (isFieldInvalid('receipt_url')) {
                <p class="text-xs text-red-600 mt-1">{{ getFieldError('receipt_url') }}</p>
                }
                @if (isReceiptRequired()) {
                <p class="text-xs text-muted-foreground mt-2 flex items-start gap-1">
                  <z-icon zType="circle-alert" class="w-3 h-3 mt-0.5 text-red-600" />
                  <span class="text-red-600">Receipt is required for this claim type</span>
                </p>
                } @else {
                <p class="text-xs text-muted-foreground mt-2 flex items-start gap-1">
                  <z-icon zType="info" class="w-3 h-3 mt-0.5" />
                  <span>Upload receipt image and paste the URL here</span>
                </p>
                }
              </div>

              <!-- File Upload Section -->
              @if (isClaimEditable()) {
              <div class="pt-2 border-t border-border">
                <div class="flex items-center justify-between mb-3">
                  <label class="block text-sm font-medium text-foreground">
                    Attach Receipt Files
                    @if (isReceiptRequired()) {
                    <span class="text-red-500">*</span>
                    } @else {
                    <span class="text-muted-foreground">(Optional)</span>
                    }
                  </label>
                </div>

                <div class="mb-2">
                  <app-file-upload [acceptedTypes]="'.pdf,.jpg,.jpeg,.png'" [multiple]="true" [maxFiles]="5"
                    [showPreview]="true" [autoUpload]="false" (filesSelected)="onFilesSelected($event)">
                  </app-file-upload>
                  <div class="mt-3 p-3 bg-muted/30 rounded-lg">
                    <p class="text-xs text-muted-foreground flex items-start gap-2">
                      <z-icon zType="info" class="w-4 h-4 mt-0" />
                      <span>Accepted formats: PDF, JPG, PNG. Maximum 5 files.</span>
                    </p>
                  </div>
                </div>

                <!-- Required Receipt Warning -->
                @if (isReceiptRequired() && receiptFiles().length === 0 && selectedClaimType()) {
                <div
                  class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 flex items-start gap-2 text-yellow-800 mt-3">
                  <z-icon zType="triangle-alert" class="w-4 h-4 mt-0.5" />
                  <span class="text-xs"><strong>Receipt Required:</strong> You must upload at least one receipt file for
                    this claim type.</span>
                </div>
                }
              </div>
              }

              <!-- View Uploaded Files (Edit Mode) -->
              @if (claimId()) {
              <div class="pt-2 border-t border-border">
                <h5 class="text-sm font-semibold text-foreground mb-3 flex items-center gap-2">
                  <z-icon zType="file-text" class="w-4 h-4" />
                  Uploaded Receipts
                </h5>
                <app-file-list [relatedToClaimId]="claimId()!" [category]="'claim_receipt'" [showFilters]="false"
                  [showActions]="isClaimEditable()" [maxDisplay]="10">
                </app-file-list>
              </div>
              }
            </div>
          </div>
        </z-card>
      </div>

      <!-- Right Column: Submission Guidelines -->
      <div class="lg:col-span-1 space-y-4">
        <!-- Submission Guidelines Card -->
        <div class="pl-5">
          <div class="flex items-center gap-2 mb-4">
            <z-icon zType="info" class="w-5 h-5 text-primary" />
            <h3 class="text-lg font-semibold text-foreground">Submission Guidelines</h3>
          </div>
          <ul class="space-y-2">
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>Select the appropriate claim type for your expense</span>
            </li>
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>Ensure the expense date is within the last 90 days</span>
            </li>
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>Enter the exact amount you spent (in Malaysian Ringgit)</span>
            </li>
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>Upload receipt files before submitting (required for some claim types)</span>
            </li>
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>Provide a clear description of the expense purpose</span>
            </li>
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>Once submitted, claims will be sent for approval</span>
            </li>
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>You can only edit claims with "Pending" status (before approval)</span>
            </li>
            <li class="flex items-start gap-2 text-sm text-foreground">
              <z-icon zType="check" class="w-4 h-4 mt-0.5 text-primary" />
              <span>Claims go through two-tier approval (Manager then Finance/Admin)</span>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="flex items-center justify-end gap-3">
      <button z-button zType="outline" type="button" (click)="claimForm.reset(); receiptFiles.set([])"
        [disabled]="submitting() || !isClaimEditable()">
        Reset
      </button>
      <button z-button type="submit" class="gap-2"
        [disabled]="submitting() || claimForm.invalid || isAmountExceedingLimit() || !isClaimEditable() || (isReceiptRequired() && receiptFiles().length === 0)">
        @if (submitting()) {
        <z-icon zType="loader-circle" class="w-4 h-4 animate-spin" />
        }
        {{ isEditMode() ? 'Update Claim' : 'Submit Claim' }}
      </button>
    </div>
  </form>
  }
</div>