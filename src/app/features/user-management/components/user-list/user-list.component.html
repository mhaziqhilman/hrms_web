<div class="bg-background min-h-screen">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-foreground">User Management</h1>
      <p class="text-muted-foreground mt-1">Manage user accounts, roles, and employee linking</p>
    </div>
  </div>

  <!-- Filters -->
  <div class="flex items-center gap-3 mb-6 flex-wrap justify-between">
    <div class="flex items-center gap-3 flex-1 flex-wrap">
      <!-- Search Bar -->
      <div class="relative flex-1 min-w-[180px] max-w-md">
        <z-icon zType="search"
          class="absolute left-1.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none" />
        <input type="text" [value]="searchTerm()" (input)="onSearch($any($event.target).value)"
          placeholder="Search by email..."
          class="w-full pl-8 pr-2 py-2 text-sm border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent" />
      </div>

      <!-- Role Filter -->
      <div z-menu [zMenuTriggerFor]="roleMenu">
        <button z-button zType="outline" [class]="roleFilter()
            ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
            : 'gap-2 border border-dashed px-2'">
          <z-icon [zType]="roleFilter() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
          {{ roleFilter() ? formatRole(roleFilter()) : 'Role' }}
        </button>
      </div>
      <ng-template #roleMenu>
        <div z-menu-content class="w-48">
          <button type="button" z-menu-item (click)="roleFilter.set(''); onFilterChange()">
            All Roles
          </button>
          @for (role of roles; track role) {
            <button type="button" z-menu-item (click)="roleFilter.set(role); onFilterChange()">
              {{ formatRole(role) }}
            </button>
          }
        </div>
      </ng-template>

      <!-- Active Status Filter -->
      <div z-menu [zMenuTriggerFor]="activeMenu">
        <button z-button zType="outline" [class]="activeFilter()
            ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
            : 'gap-2 border border-dashed px-2'">
          <z-icon [zType]="activeFilter() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
          {{ activeFilter() === 'true' ? 'Active' : activeFilter() === 'false' ? 'Inactive' : 'Status' }}
        </button>
      </div>
      <ng-template #activeMenu>
        <div z-menu-content class="w-48">
          <button type="button" z-menu-item (click)="activeFilter.set(''); onFilterChange()">
            All
          </button>
          <button type="button" z-menu-item (click)="activeFilter.set('true'); onFilterChange()">
            Active
          </button>
          <button type="button" z-menu-item (click)="activeFilter.set('false'); onFilterChange()">
            Inactive
          </button>
        </div>
      </ng-template>

      <!-- Company Filter (Super Admin only) -->
      @if (isSuperAdmin()) {
        <div z-menu [zMenuTriggerFor]="companyMenu">
          <button z-button zType="outline" [class]="companyFilter()
              ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
              : 'gap-2 border border-dashed px-2'">
            <z-icon [zType]="companyFilter() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
            {{ companyFilter() ? getCompanyFilterName() : 'Company' }}
          </button>
        </div>
        <ng-template #companyMenu>
          <div z-menu-content class="w-56 max-h-64 overflow-y-auto">
            <button type="button" z-menu-item (click)="companyFilter.set(''); onFilterChange()">
              All Companies
            </button>
            @for (company of companies(); track company.id) {
              <button type="button" z-menu-item (click)="companyFilter.set(company.id.toString()); onFilterChange()"
                class="justify-between">
                {{ company.name }}
                @if (companyFilter() === company.id.toString()) {
                  <z-icon zType="check" class="w-4 h-4" />
                }
              </button>
            }
          </div>
        </ng-template>
      }

      <!-- Clear Filters -->
      @if (hasActiveFilters()) {
        <button type="button" z-button zType="outline" class="gap-2 border-none shadow-none px-2"
          (click)="clearFilters()">
          Reset
          <z-icon zType="x" class="w-4 h-4" />
        </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="flex items-center justify-center py-20">
      <z-icon zType="loader-circle" class="w-8 h-8 animate-spin text-primary" />
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-2 text-red-800 mb-6">
      <z-icon zType="triangle-alert" class="w-5 h-5" />
      <span>{{ error() }}</span>
      <button z-button zType="outline" zSize="sm" class="ml-auto" (click)="loadUsers()">Retry</button>
    </div>
  }

  <!-- Table -->
  @if (!loading() && !error()) {
    @if (users().length > 0) {
      <div class="rounded-lg border">
        <table z-table>
          <thead>
            <tr>
              <th class="!pl-4">
                <button (click)="onSort('email')"
                  class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                  [class.text-primary]="sortColumn() === 'email'">
                  <span>User</span>
                  <z-icon [zType]="getSortIcon('email')" class="w-4 h-4" />
                </button>
              </th>
              <th>
                <button (click)="onSort('role')"
                  class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                  [class.text-primary]="sortColumn() === 'role'">
                  <span>Role</span>
                  <z-icon [zType]="getSortIcon('role')" class="w-4 h-4" />
                </button>
              </th>
              <th>
                <button (click)="onSort('company')"
                  class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                  [class.text-primary]="sortColumn() === 'company'">
                  <span>Company</span>
                  <z-icon [zType]="getSortIcon('company')" class="w-4 h-4" />
                </button>
              </th>
              <th>Linked Employee</th>
              <th>
                <button (click)="onSort('status')"
                  class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                  [class.text-primary]="sortColumn() === 'status'">
                  <span>Status</span>
                  <z-icon [zType]="getSortIcon('status')" class="w-4 h-4" />
                </button>
              </th>
              <th>
                <button (click)="onSort('lastLogin')"
                  class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                  [class.text-primary]="sortColumn() === 'lastLogin'">
                  <span>Last Login</span>
                  <z-icon [zType]="getSortIcon('lastLogin')" class="w-4 h-4" />
                </button>
              </th>
              <th class="!pr-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (user of users(); track user.id) {
              <tr>
                <!-- User -->
                <td class="!pl-4">
                  <div class="flex items-center gap-3">
                    <z-avatar [zFallback]="getUserInitial(user)" class="w-9 h-9" />
                    <div>
                      <span class="font-medium text-foreground block text-sm">{{ getDisplayName(user) }}</span>
                      <span class="text-muted-foreground text-xs">{{ user.email }}</span>
                    </div>
                  </div>
                </td>

                <!-- Role -->
                <td>
                  @if (isSuperAdmin()) {
                    <div z-menu [zMenuTriggerFor]="roleChangeMenu">
                      <button class="cursor-pointer">
                        <z-badge [zType]="getRoleBadgeType(user.role)" class="text-xs">
                          {{ formatRole(user.role) }}
                        </z-badge>
                      </button>
                    </div>
                    <ng-template #roleChangeMenu>
                      <div z-menu-content class="w-44">
                        <div class="px-2 py-1.5 text-xs font-semibold text-muted-foreground">Change Role</div>
                        @for (role of roles; track role) {
                          <button type="button" z-menu-item (click)="changeRole(user, role)" class="justify-between">
                            {{ formatRole(role) }}
                            @if (user.role === role) {
                              <z-icon zType="check" class="w-4 h-4" />
                            }
                          </button>
                        }
                      </div>
                    </ng-template>
                  } @else {
                    <z-badge [zType]="getRoleBadgeType(user.role)" class="text-xs">
                      {{ formatRole(user.role) }}
                    </z-badge>
                  }
                </td>

                <!-- Company -->
                <td>
                  @if (user.company) {
                    <span class="text-sm text-foreground">{{ user.company.name }}</span>
                  } @else {
                    <span class="text-muted-foreground text-xs italic">No company</span>
                  }
                </td>

                <!-- Linked Employee -->
                <td>
                  @if (user.employee) {
                    <div class="flex items-center gap-2">
                      <div>
                        <span class="text-foreground text-sm font-medium block">{{ user.employee.full_name }}</span>
                        <span class="text-muted-foreground text-xs">{{ user.employee.employee_id }} - {{ user.employee.department }}</span>
                      </div>
                    </div>
                  } @else {
                    <span class="text-muted-foreground text-xs italic">Not linked</span>
                  }
                </td>

                <!-- Status -->
                <td>
                  <z-badge [zType]="user.is_active ? 'default' : 'destructive'" class="text-xs">
                    {{ user.is_active ? 'Active' : 'Inactive' }}
                  </z-badge>
                  @if (user.locked_until) {
                    <z-badge zType="outline" class="text-xs ml-1">Locked</z-badge>
                  }
                </td>

                <!-- Last Login -->
                <td>
                  <span class="text-sm text-muted-foreground">{{ formatDate(user.last_login_at) }}</span>
                </td>

                <!-- Actions -->
                <td class="!pr-4 text-right">
                  <div class="flex gap-1 justify-end">
                    <!-- Link/Unlink Employee -->
                    @if (user.employee) {
                      <button z-button zType="outline" zSize="sm" [zTooltip]="'Unlink Employee'"
                        (click)="unlinkEmployee(user)" class="text-orange-600 hover:text-orange-700">
                        <z-icon zType="unlink" class="w-4 h-4" />
                      </button>
                    } @else {
                      <button z-button zType="outline" zSize="sm" [zTooltip]="'Link Employee'"
                        (click)="openLinkModal(user)">
                        <z-icon zType="link" class="w-4 h-4" />
                      </button>
                    }

                    <!-- More Actions Menu -->
                    <div z-menu [zMenuTriggerFor]="actionsMenu">
                      <button z-button zType="outline" zSize="sm" [zTooltip]="'More Actions'">
                        <z-icon zType="ellipsis" class="w-4 h-4" />
                      </button>
                    </div>
                    <ng-template #actionsMenu>
                      <div z-menu-content class="w-48">
                        <button type="button" z-menu-item (click)="toggleActive(user)">
                          <z-icon [zType]="$any(user.is_active ? 'user-x' : 'user-check')" class="mr-2 w-4 h-4" />
                          {{ user.is_active ? 'Deactivate' : 'Activate' }}
                        </button>
                        <button type="button" z-menu-item (click)="openResetModal(user)">
                          <z-icon zType="key-round" class="mr-2 w-4 h-4" />
                          Reset Password
                        </button>
                      </div>
                    </ng-template>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Empty State -->
    @if (users().length === 0) {
      <div class="bg-card border rounded-lg">
        <div class="flex flex-col items-center justify-center py-20 text-center">
          <z-icon zType="users" class="w-16 h-16 text-muted-foreground mb-4" />
          <h3 class="text-lg font-semibold mb-2">No Users Found</h3>
          <p class="text-muted-foreground mb-4">There are no users matching your criteria</p>
        </div>
      </div>
    }

    <!-- Pagination -->
    @if (users().length > 0) {
      <div class="flex items-center justify-between mt-4">
        <div class="text-sm text-muted-foreground">
          Showing {{ (currentPage() - 1) * limit() + 1 }} to
          {{ Math.min(currentPage() * limit(), totalUsers()) }} of
          {{ totalUsers() }} users
        </div>
        <div class="flex items-center gap-1">
          <button z-button zType="outline" zSize="sm" (click)="onPageChange(currentPage() - 1)"
            [disabled]="currentPage() === 1">
            Previous
          </button>
          @for (page of [].constructor(Math.min(totalPages(), 5)); track $index) {
            <button z-button [zType]="currentPage() === $index + 1 ? 'default' : 'outline'" zSize="sm"
              (click)="onPageChange($index + 1)" class="min-w-[36px]">
              {{ $index + 1 }}
            </button>
          }
          <button z-button zType="outline" zSize="sm" (click)="onPageChange(currentPage() + 1)"
            [disabled]="currentPage() === totalPages()">
            Next
          </button>
        </div>
      </div>
    }
  }
</div>

<!-- Link Employee Modal -->
@if (showLinkModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" (click)="closeLinkModal()"></div>
    <div class="relative bg-background rounded-lg shadow-lg w-full max-w-lg mx-4 max-h-[80vh] flex flex-col">
      <!-- Modal Header -->
      <div class="p-6 border-b flex-shrink-0">
        <h3 class="text-lg font-semibold text-foreground">Link Employee</h3>
        <p class="text-muted-foreground text-sm mt-1">
          Select an employee to link to <span class="font-medium text-foreground">{{ linkingUserEmail() }}</span>
        </p>
      </div>

      <!-- Search -->
      <div class="px-6 pt-4 flex-shrink-0">
        <div class="relative">
          <z-icon zType="search"
            class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none" />
          <input type="text" [value]="employeeSearchTerm()" (input)="employeeSearchTerm.set($any($event.target).value)"
            placeholder="Search employees..."
            class="w-full pl-9 pr-3 py-2 text-sm border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring" />
        </div>
      </div>

      <!-- Employee List -->
      <div class="p-6 overflow-y-auto flex-1">
        @if (loadingEmployees()) {
          <div class="flex items-center justify-center py-8">
            <z-icon zType="loader-circle" class="w-6 h-6 animate-spin text-primary" />
          </div>
        } @else if (getFilteredEmployees().length === 0) {
          <div class="text-center py-8">
            <z-icon zType="user-x" class="w-10 h-10 text-muted-foreground mb-3 mx-auto" />
            <p class="text-muted-foreground text-sm">No unlinked employees found</p>
          </div>
        } @else {
          <div class="space-y-2">
            @for (emp of getFilteredEmployees(); track emp.id) {
              <button
                (click)="linkEmployee(emp.id)"
                class="w-full flex items-center gap-3 p-3 rounded-md border hover:bg-accent hover:border-primary transition-colors text-left cursor-pointer">
                <z-avatar [zFallback]="emp.full_name.charAt(0)" class="w-9 h-9" />
                <div class="flex-1 min-w-0">
                  <span class="font-medium text-foreground block text-sm truncate">{{ emp.full_name }}</span>
                  <span class="text-muted-foreground text-xs">{{ emp.employee_id }} - {{ emp.department || 'No Dept' }} - {{ emp.position || 'No Position' }}</span>
                </div>
              </button>
            }
          </div>
        }
      </div>

      <!-- Modal Footer -->
      <div class="p-6 border-t flex-shrink-0">
        <button z-button zType="outline" class="w-full" (click)="closeLinkModal()">Cancel</button>
      </div>
    </div>
  </div>
}

<!-- Reset Password Modal -->
@if (showResetModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center">
    <div class="absolute inset-0 bg-black/50" (click)="closeResetModal()"></div>
    <div class="relative bg-background rounded-lg shadow-lg w-full max-w-sm mx-4">
      <div class="p-6">
        <h3 class="text-lg font-semibold text-foreground mb-1">Reset Password</h3>
        <p class="text-muted-foreground text-sm mb-4">
          Set new password for <span class="font-medium text-foreground">{{ resetUserEmail() }}</span>
        </p>
        <div class="mb-4">
          <label class="block text-sm font-medium text-foreground mb-1.5">New Password</label>
          <input
            type="password"
            [value]="newPassword()"
            (input)="newPassword.set($any($event.target).value)"
            placeholder="Minimum 8 characters"
            class="w-full px-3 py-2 text-sm border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring" />
          @if (newPassword().length > 0 && newPassword().length < 8) {
            <p class="text-red-500 text-xs mt-1">Password must be at least 8 characters</p>
          }
        </div>
        <div class="flex gap-2">
          <button z-button zType="outline" class="flex-1" (click)="closeResetModal()">Cancel</button>
          <button z-button class="flex-1" (click)="resetPassword()"
            [disabled]="newPassword().length < 8">
            Reset Password
          </button>
        </div>
      </div>
    </div>
  </div>
}
