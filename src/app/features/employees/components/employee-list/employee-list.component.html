<div class="bg-background min-h-screen">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold text-foreground">Users</h1>
    <button z-button [routerLink]="['/employees/new']" class="gap-2">
      <z-icon zType="plus" class="w-4 h-4" />
      Add New User
    </button>
  </div>

  <!-- Filters -->
  <div class="flex items-center gap-3 mb-6 flex-wrap justify-between">
    <div class="flex items-center gap-3 flex-1 flex-wrap">
      <!-- Search Bar -->
      <div class="relative flex-1 min-w-[180px] max-w-md">
        <z-icon zType="search"
          class="absolute left-1.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground pointer-events-none" />
        <input type="text" [value]="searchTerm()" (input)="onSearch($any($event.target).value)"
          placeholder="Search by name or email..."
          class="w-full pl-8 pr-2 py-2 text-sm border border-input rounded-md bg-background focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent" />
      </div>

      <!-- Status Filter -->
      <div z-menu [zMenuTriggerFor]="statusMenu">
        <button z-button zType="outline" [class]="statusFilter()
            ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
            : 'gap-2 border border-dashed px-2'">
          <z-icon [zType]="statusFilter() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
          {{ statusFilter() ? statusFilter() : 'Status' }}
        </button>
      </div>
      <ng-template #statusMenu>
        <div z-menu-content class="w-48">
          <button type="button" z-menu-item (click)="statusFilter.set(''); onFilterChange()">
            All Status
          </button>
          @for (status of employmentStatuses; track status) {
          <button type="button" z-menu-item (click)="statusFilter.set(status); onFilterChange()">
            {{status}}
          </button>
          }
        </div>
      </ng-template>

      <!-- Employment Type Filter -->
      <div z-menu [zMenuTriggerFor]="typeMenu">
        <button z-button zType="outline" [class]="employmentTypeFilter()
            ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
            : 'gap-2 border border-dashed px-2'">
          <z-icon [zType]="employmentTypeFilter() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
          {{ employmentTypeFilter() ? employmentTypeFilter() : 'Plan' }}
        </button>
      </div>
      <ng-template #typeMenu>
        <div z-menu-content class="w-48">
          <button type="button" z-menu-item (click)="employmentTypeFilter.set(''); onFilterChange()">
            All Types
          </button>
          @for (type of employmentTypes; track type) {
          <button type="button" z-menu-item (click)="employmentTypeFilter.set(type); onFilterChange()">
            {{type}}
          </button>
          }
        </div>
      </ng-template>

      <!-- Role Filter (Department) -->
      <div z-menu [zMenuTriggerFor]="roleMenu">
        <button z-button zType="outline" [class]="departmentFilter()
            ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
            : 'gap-2 border border-dashed px-2'">
          <z-icon [zType]="departmentFilter() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
          {{ departmentFilter() ? departmentFilter() : 'Role' }}
        </button>
      </div>
      <ng-template #roleMenu>
        <div z-menu-content class="w-48">
          <button type="button" z-menu-item (click)="departmentFilter.set(''); onFilterChange()">
            All Roles
          </button>
          <button type="button" z-menu-item (click)="departmentFilter.set('IT'); onFilterChange()">
            IT
          </button>
          <button type="button" z-menu-item (click)="departmentFilter.set('HR'); onFilterChange()">
            HR
          </button>
          <button type="button" z-menu-item (click)="departmentFilter.set('Finance'); onFilterChange()">
            Finance
          </button>
        </div>
      </ng-template>

      <!-- Clear Filters -->
      <button *ngIf="statusFilter() || employmentTypeFilter() || departmentFilter() || searchTerm()" type="button"
        z-button zType="outline" class="gap-2 border-none shadow-none px-2" (click)="clearFilters()">
        Reset
        <z-icon zType="x" class="w-4 h-4" />
      </button>
    </div>

    <!-- Column Toggle - Right Side -->
    <div z-menu [zMenuTriggerFor]="columnMenu">
      <button z-button zType="outline" class="gap-2 px-2">
        <z-icon zType="eye" class="w-4 h-4" />
        View
      </button>
    </div>
    <ng-template #columnMenu>
      <div z-menu-content class="w-56">
        <div class="px-2 py-1.5 text-xs font-semibold text-muted-foreground">
          Toggle Columns
        </div>
        @for (column of columnList; track column.key) {
        <button type="button" z-menu-item (click)="toggleColumn(column.key)" class="justify-between">
          {{ column.label }}
          @if (visibleColumns()[column.key]) {
          <z-icon zType="check" class="w-4 h-4" />
          } @else {
          <span class="w-4 h-4"></span>
          }
        </button>
        }
      </div>
    </ng-template>
  </div>

  <!-- Loading State -->
  @if (loading()) {
  <div class="flex items-center justify-center py-20">
    <z-icon zType="loader-circle" class="w-8 h-8 animate-spin text-primary" />
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-2 text-red-800 mb-6">
    <z-icon zType="triangle-alert" class="w-5 h-5" />
    <span>{{ error() }}</span>
  </div>
  }

  <!-- Bulk Actions Bar - Modern SaaS Style -->
  @if (getSelectedCount() > 0) {
  <div
    class="mb-4 bg-gradient-to-r from-primary/5 via-primary/10 to-primary/5 backdrop-blur-sm border-l-4 border-primary shadow-sm">
    <div class="flex items-center justify-between px-6 py-3 gap-4">
      <!-- Left: Selection Info -->
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/20">
          <z-icon zType="check-circle" class="w-4 h-4 text-primary" />
        </div>
        <div class="flex flex-col">
          <span class="text-sm font-semibold text-foreground">{{ getSelectedCount() }} Selected</span>
          <span class="text-xs text-muted-foreground">Bulk actions available</span>
        </div>
      </div>

      <!-- Right: Action Buttons -->
      <div class="flex items-center gap-2">
        <button type="button" (click)="bulkDelete()"
          class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-destructive hover:bg-destructive/90 rounded-md transition-all duration-200 shadow-sm hover:shadow-md">
          <z-icon zType="user-minus" class="w-4 h-4" />
          <span>Terminate</span>
        </button>
        <div class="w-px h-6 bg-border mx-1"></div>
        <button type="button" (click)="clearSelection()"
          class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors duration-200">
          <z-icon zType="x" class="w-4 h-4" />
          <span>Clear</span>
        </button>
      </div>
    </div>
  </div>
  }

  <!-- Table -->
  @if (!loading() && !error()) {
  <div class="employee-table-container rounded-lg border" *ngIf="employees().length > 0">
    <table z-table class="employee-table">
      <thead>
        <tr>
          <!-- Checkbox Column -->
          <th class="!pl-3 w-10 th-text-center">
            <span z-checkbox class="border-primary/30" [(ngModel)]="selectAll"
              (ngModelChange)="toggleSelectAll()"></span>
          </th>
          <!-- <th class="!pl-3 w-10 th-text-center">
            <input type="checkbox" [checked]="selectAll()" (change)="toggleSelectAll()"
              class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer" />
          </th> -->

          <!-- Name Column - Sortable -->
          <th class="!pl-3" *ngIf="visibleColumns()['name']">
            <button (click)="onSort('name')"
              class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
              [class.text-primary]="isSortActive('name')">
              <span>Name</span>
              <z-icon [zType]="getSortIcon('name')" class="w-4 h-4" />
            </button>
          </th>

          <!-- Role Column - Sortable -->
          <th *ngIf="visibleColumns()['position']">
            <button (click)="onSort('position')"
              class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
              [class.text-primary]="isSortActive('position')">
              <span>Role</span>
              <z-icon [zType]="getSortIcon('position')" class="w-4 h-4" />
            </button>
          </th>

          <!-- Plan Column - Sortable -->
          <th *ngIf="visibleColumns()['employmentType']">
            <button (click)="onSort('employmentType')"
              class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
              [class.text-primary]="isSortActive('employmentType')">
              <span>Plan</span>
              <z-icon [zType]="getSortIcon('employmentType')" class="w-4 h-4" />
            </button>
          </th>

          <!-- Email Column - Sortable -->
          <th *ngIf="visibleColumns()['email']">
            <button (click)="onSort('email')"
              class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
              [class.text-primary]="isSortActive('email')">
              <span>Email</span>
              <z-icon [zType]="getSortIcon('email')" class="w-4 h-4" />
            </button>
          </th>

          <!-- Country Column - Sortable -->
          <th *ngIf="visibleColumns()['nationality']">
            <button (click)="onSort('nationality')"
              class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
              [class.text-primary]="isSortActive('nationality')">
              <span>Country</span>
              <z-icon [zType]="getSortIcon('nationality')" class="w-4 h-4" />
            </button>
          </th>

          <!-- Status Column - Sortable -->
          <th *ngIf="visibleColumns()['status']">
            <button (click)="onSort('status')"
              class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
              [class.text-primary]="isSortActive('status')">
              <span>Status</span>
              <z-icon [zType]="getSortIcon('status')" class="w-4 h-4" />
            </button>
          </th>

          <!-- Actions Column -->
          <th class="!pr-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        @for (employee of employees(); track employee.id) {
        <tr>
          <!-- Checkbox -->
          <td class="!pl-3 text-center">
            <span z-checkbox [ngModel]="isEmployeeSelected(employee.id)"
              (ngModelChange)="toggleEmployeeSelection(employee.id)"
              class="border-primary/30"></span>
          </td>
          <!-- <td class="!pl-3 text-center">
            <input type="checkbox" [checked]="isEmployeeSelected(employee.id)"
              (change)="toggleEmployeeSelection(employee.id)"
              class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer" />
          </td> -->

          <!-- Name -->
          @if (visibleColumns()['name']) {
          <td class="!pl-3">
            <div class="flex items-center gap-3">
              <z-avatar [zFallback]="employee.full_name.charAt(0)" class="w-10 h-10" />
              <span class="font-medium text-foreground">{{employee.full_name}}</span>
            </div>
          </td>
          }

          <!-- Role -->
          @if (visibleColumns()['position']) {
          <td>{{employee.position || 'Staff'}}</td>
          }

          <!-- Plan -->
          @if (visibleColumns()['employmentType']) {
          <td>{{employee.employment_type}}</td>
          }

          <!-- Email -->
          @if (visibleColumns()['email']) {
          <td>{{employee.email}}</td>
          }

          <!-- Country -->
          @if (visibleColumns()['nationality']) {
          <td>{{employee.nationality || '-'}}</td>
          }

          <!-- Status -->
          @if (visibleColumns()['status']) {
          <td>
            <z-badge
              [zType]="employee.employment_status === 'Active' ? 'default' : employee.employment_status === 'Resigned' ? 'secondary' : 'destructive'"
              [zShape]="'pill'" class="text-xs">
              {{employee.employment_status}}
            </z-badge>
          </td>
          }

          <!-- Actions -->
          <td class="!pr-3 text-right">
            <div class="flex gap-2 flex-nowrap justify-end">
              <a [routerLink]="['/employees', employee.id]" z-button zType="outline" zSize="sm" [zTooltip]="'View'">
                <z-icon zType="eye" class="w-4 h-4" />
              </a>
              <a [routerLink]="['/employees', employee.id, 'edit']" z-button zType="outline" zSize="sm"
                [zTooltip]="'Edit'">
                <z-icon zType="pencil" class="w-4 h-4" />
              </a>
              <button (click)="deleteEmployee(employee)" z-button zType="outline" zSize="sm" [zTooltip]="'Delete'"
                class="text-red-600 hover:text-red-700">
                <z-icon zType="trash" class="w-4 h-4" />
              </button>
            </div>
          </td>
        </tr>
        }
      </tbody>
    </table>

  </div>

  <!-- Empty State -->
  @if (employees().length === 0) {
  <div class="bg-card border rounded-lg">
    <div class="flex flex-col items-center justify-center py-20 text-center">
      <z-icon zType="users" class="w-16 h-16 text-muted-foreground mb-4" />
      <h3 class="text-lg font-semibold mb-2">No Users Found</h3>
      <p class="text-muted-foreground mb-4">There are no users matching your criteria</p>
      <button z-button [routerLink]="['/employees/new']">
        <z-icon zType="plus" class="mr-2" />
        Add New User
      </button>
    </div>
  </div>
  }

  <!-- Pagination -->
  @if (employees().length > 0) {
  <div class="flex items-center justify-between mt-4">
    <div class="text-sm text-muted-foreground">
      Showing {{ (currentPage() - 1) * limit() + 1 }} to
      {{ Math.min(currentPage() * limit(), totalEmployees()) }} of
      {{ totalEmployees() }} users
    </div>
    <div class="flex items-center gap-1">
      <button z-button zType="outline" zSize="sm" (click)="onPageChange(currentPage() - 1)"
        [disabled]="currentPage() === 1">
        Previous
      </button>
      @for (page of [].constructor(Math.min(totalPages(), 5)); track $index) {
      <button z-button [zType]="currentPage() === $index + 1 ? 'default' : 'outline'" zSize="sm"
        (click)="onPageChange($index + 1)" class="min-w-[36px]">
        {{ $index + 1 }}
      </button>
      }
      <button z-button zType="outline" zSize="sm" (click)="onPageChange(currentPage() + 1)"
        [disabled]="currentPage() === totalPages()">
        Next
      </button>
    </div>
  </div>
  }
  }
</div>