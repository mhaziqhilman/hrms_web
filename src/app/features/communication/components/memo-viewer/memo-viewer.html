<div class="max-w-5xl mx-auto p-6">
  <!-- Loading State -->
  <z-card *ngIf="loading()" class="mb-6">
    <div class="flex flex-col items-center justify-center py-16">
      <z-icon zType="loader-circle" class="w-12 h-12 text-primary animate-spin" />
      <p class="text-muted-foreground mt-4">Loading memo...</p>
    </div>
  </z-card>

  <!-- Error State -->
  <z-card *ngIf="error()" class="mb-6 border-destructive">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-2 text-destructive">
        <z-icon zType="triangle-alert" class="w-5 h-5" />
        <span>{{ error() }}</span>
      </div>
      <button z-button zType="outline" (click)="goBack()" class="flex items-center gap-2">
        Go Back to List
      </button>
    </div>
  </z-card>

  <!-- Memo Content -->
  <div *ngIf="!loading() && memo() && !error()">
    <!-- Header Actions -->
    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <button z-button zType="outline" (click)="goBack()" class="flex items-center gap-2">
        <z-icon zType="arrow-left" class="w-4 h-4" />
        Back to List
      </button>
      <div class="flex gap-2 flex-wrap">
        <button
          *ngIf="memo()?.status === 'Draft' && canEdit()"
          z-button
          zType="default"
          (click)="publishMemo()"
          class="flex items-center gap-2"
        >
          <z-icon zType="send" class="w-4 h-4" />
          Publish
        </button>
        <button
          *ngIf="memo()?.status === 'Published' && canEdit()"
          z-button
          zType="outline"
          (click)="archiveMemo()"
          class="flex items-center gap-2"
        >
          <z-icon zType="archive" class="w-4 h-4" />
          Archive
        </button>
        <a
          *ngIf="canEdit()"
          [routerLink]="['/dashboard/communication/memos', memo()?.id, 'edit']"
          z-button
          zType="default"
          class="flex items-center gap-2"
        >
          <z-icon zType="pencil" class="w-4 h-4" />
          Edit
        </a>
        <button
          *ngIf="canDelete()"
          z-button
          zType="destructive"
          (click)="deleteMemo()"
          class="flex items-center gap-2"
        >
          <z-icon zType="trash" class="w-4 h-4" />
          Delete
        </button>
      </div>
    </div>

    <!-- Memo Card -->
    <z-card class="mb-6" [class.opacity-70]="isExpired()" [class.border-l-4]="isExpired()" [class.border-l-destructive]="isExpired()">
      <!-- Badges Section -->
      <div class="flex flex-wrap gap-2 mb-6">
        <z-badge *ngIf="memo()?.priority" [zType]="getPriorityBadgeType(memo()!.priority)">
          <z-icon zType="flag" class="w-3 h-3 mr-1" />
          {{ memo()?.priority }}
        </z-badge>
        <z-badge *ngIf="memo()?.status" [zType]="getStatusBadgeType(memo()!.status)">
          {{ memo()?.status }}
        </z-badge>
        <z-badge zType="default" *ngIf="memo()?.requires_acknowledgment">
          <z-icon zType="check-square" class="w-3 h-3 mr-1" />
          Requires Acknowledgment
        </z-badge>
        <z-badge zType="destructive" *ngIf="isExpired()">
          <z-icon zType="clock" class="w-3 h-3 mr-1" />
          Expired
        </z-badge>
      </div>

      <!-- Title -->
      <h1 class="text-3xl font-bold text-foreground mb-6">{{ memo()?.title }}</h1>

      <!-- Meta Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 p-4 bg-muted/30 rounded-lg">
        <div class="flex items-start gap-3" *ngIf="memo()?.author">
          <z-icon zType="user" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Author</div>
            <div class="text-foreground">{{ memo()?.author?.full_name }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3" *ngIf="memo()?.published_at">
          <z-icon zType="calendar" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Published</div>
            <div class="text-foreground">{{ memo()?.published_at | date:'MMM dd, yyyy h:mm a' }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3" *ngIf="memo()?.expires_at">
          <z-icon zType="clock" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Expires</div>
            <div class="text-foreground">{{ memo()?.expires_at | date:'MMM dd, yyyy' }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3">
          <z-icon zType="users" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Target Audience</div>
            <div class="text-foreground">{{ memo()?.target_audience }}</div>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="mb-6 p-4 bg-primary/5 border-l-4 border-l-primary rounded" *ngIf="memo()?.summary">
        <h5 class="font-semibold text-foreground mb-2">Summary</h5>
        <p class="text-muted-foreground">{{ memo()?.summary }}</p>
      </div>

      <!-- Content -->
      <div class="prose max-w-none mb-6">
        <div [innerHTML]="memo()?.content"></div>
      </div>

      <!-- Statistics -->
      <div class="grid grid-cols-2 gap-4 p-4 bg-muted/30 rounded-lg">
        <div class="flex items-center gap-3">
          <z-icon zType="eye" class="w-6 h-6 text-primary" />
          <div>
            <div class="text-2xl font-bold text-foreground">{{ memo()?.view_count || 0 }}</div>
            <div class="text-sm text-muted-foreground">Views</div>
          </div>
        </div>
        <div class="flex items-center gap-3" *ngIf="memo()?.requires_acknowledgment">
          <z-icon zType="check-circle" class="w-6 h-6 text-green-600" />
          <div>
            <div class="text-2xl font-bold text-foreground">{{ memo()?.acknowledgment_count || 0 }}</div>
            <div class="text-sm text-muted-foreground">Acknowledged</div>
          </div>
        </div>
      </div>
    </z-card>

    <!-- Acknowledgment Section -->
    <z-card class="mb-6" *ngIf="memo()?.requires_acknowledgment && !hasAcknowledged()">
      <div class="bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
        <div class="flex items-center gap-2 text-blue-800 dark:text-blue-200">
          <z-icon zType="info" class="w-5 h-5" />
          <span>This memo requires your acknowledgment</span>
        </div>
      </div>
      <button
        z-button
        zType="default"
        (click)="acknowledgeMemo()"
        [disabled]="acknowledging()"
        class="w-full flex items-center justify-center gap-2 text-lg py-6"
      >
        <z-icon *ngIf="!acknowledging()" zType="check-circle" class="w-5 h-5" />
        <z-icon *ngIf="acknowledging()" zType="loader-circle" class="w-5 h-5 animate-spin" />
        {{ acknowledging() ? 'Acknowledging...' : 'Acknowledge Receipt' }}
      </button>
    </z-card>

    <!-- Acknowledged Message -->
    <z-card class="mb-6 bg-green-50 dark:bg-green-950 border-green-500" *ngIf="hasAcknowledged()">
      <div class="flex items-center gap-2 text-green-800 dark:text-green-200">
        <z-icon zType="check-circle" class="w-5 h-5" />
        <span class="font-semibold">You have acknowledged this memo</span>
      </div>
    </z-card>

    <!-- Statistics Card (Admin/Manager/Author) -->
    <z-card *ngIf="canViewStatistics() && statistics()">
      <h4 class="text-xl font-semibold text-foreground mb-6 flex items-center gap-2">
        <z-icon zType="bar-chart" class="w-6 h-6" />
        Statistics
      </h4>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="p-6 bg-primary/5 rounded-lg border border-primary/20">
          <div class="text-3xl font-bold text-primary mb-1">{{ statistics()?.total_reads }}</div>
          <div class="text-sm text-muted-foreground mb-2">Total Reads</div>
          <div class="text-lg font-semibold text-foreground">{{ statistics()?.read_percentage }}%</div>
        </div>

        <div class="p-6 bg-green-50 dark:bg-green-950 rounded-lg border border-green-200 dark:border-green-800" *ngIf="memo()?.requires_acknowledgment">
          <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-1">{{ statistics()?.total_acknowledgments }}</div>
          <div class="text-sm text-muted-foreground mb-2">Acknowledged</div>
          <div class="text-lg font-semibold text-foreground">{{ statistics()?.acknowledgment_percentage }}%</div>
        </div>

        <div class="p-6 bg-muted/50 rounded-lg border border-border">
          <div class="text-3xl font-bold text-foreground mb-1">{{ statistics()?.target_count }}</div>
          <div class="text-sm text-muted-foreground">Target Recipients</div>
        </div>
      </div>

      <!-- Read Receipts Table -->
      <div *ngIf="statistics()?.read_receipts && statistics()!.read_receipts.length > 0">
        <h5 class="text-lg font-semibold text-foreground mb-4">Read Receipts</h5>
        <div class="overflow-x-auto">
          <table z-table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Read At</th>
                <th *ngIf="memo()?.requires_acknowledgment">Acknowledged At</th>
                <th>IP Address</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let receipt of statistics()?.read_receipts">
                <td class="font-medium">{{ receipt.employee?.full_name || 'Unknown' }}</td>
                <td>{{ receipt.read_at | date:'MMM dd, yyyy h:mm a' }}</td>
                <td *ngIf="memo()?.requires_acknowledgment">
                  <z-badge zType="default" *ngIf="receipt.acknowledged_at">
                    {{ receipt.acknowledged_at | date:'MMM dd, yyyy h:mm a' }}
                  </z-badge>
                  <z-badge zType="secondary" *ngIf="!receipt.acknowledged_at">
                    Not Acknowledged
                  </z-badge>
                </td>
                <td>
                  <span class="text-sm text-muted-foreground">{{ receipt.ip_address || 'N/A' }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </z-card>
  </div>
</div>
