<div class="max-w-5xl mx-auto p-6">
  <!-- Loading State -->
  <z-card *ngIf="loading()" class="mb-6">
    <div class="flex flex-col items-center justify-center py-16">
      <z-icon zType="loader-circle" class="w-12 h-12 text-primary animate-spin" />
      <p class="text-muted-foreground mt-4">Loading policy...</p>
    </div>
  </z-card>

  <!-- Error State -->
  <z-card *ngIf="error()" class="mb-6 border-destructive">
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-2 text-destructive">
        <z-icon zType="triangle-alert" class="w-5 h-5" />
        <span>{{ error() }}</span>
      </div>
      <button z-button zType="outline" (click)="goBack()" class="flex items-center gap-2">
        Go Back to List
      </button>
    </div>
  </z-card>

  <!-- Policy Content -->
  <div *ngIf="!loading() && policy() && !error()">
    <!-- Header Actions -->
    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <button z-button zType="outline" (click)="goBack()" class="flex items-center gap-2">
        <z-icon zType="arrow-left" class="w-4 h-4" />
        Back to List
      </button>
      <div class="flex gap-2 flex-wrap">
        <button
          *ngIf="policy()?.status === 'Draft' && canApprove()"
          z-button
          zType="default"
          (click)="approvePolicy()"
          class="flex items-center gap-2"
        >
          <z-icon zType="check-circle" class="w-4 h-4" />
          Approve Policy
        </button>
        <button
          *ngIf="policy()?.status === 'Draft' && canEdit()"
          z-button
          zType="default"
          (click)="activatePolicy()"
          class="flex items-center gap-2"
        >
          <z-icon zType="circle-check" class="w-4 h-4" />
          Activate
        </button>
        <button
          *ngIf="policy()?.status === 'Active' && canEdit()"
          z-button
          zType="outline"
          (click)="archivePolicy()"
          class="flex items-center gap-2"
        >
          <z-icon zType="archive" class="w-4 h-4" />
          Archive
        </button>
        <button
          *ngIf="policy()?.file_url"
          z-button
          zType="outline"
          (click)="downloadPolicy()"
          class="flex items-center gap-2"
        >
          <z-icon zType="download" class="w-4 h-4" />
          Download
        </button>
        <a
          *ngIf="canEdit()"
          [routerLink]="['/communication/policies', policy()?.id, 'edit']"
          z-button
          zType="default"
          class="flex items-center gap-2"
        >
          <z-icon zType="pencil" class="w-4 h-4" />
          Edit
        </a>
        <button
          *ngIf="canDelete()"
          z-button
          zType="destructive"
          (click)="deletePolicy()"
          class="flex items-center gap-2"
        >
          <z-icon zType="trash" class="w-4 h-4" />
          Delete
        </button>
      </div>
    </div>

    <!-- Policy Card -->
    <z-card class="mb-6" [class.opacity-70]="isExpired()" [class.border-l-4]="isExpired()" [class.border-l-destructive]="isExpired()">
      <!-- Policy Header -->
      <div class="flex justify-between items-start mb-6 flex-wrap gap-4">
        <div class="flex items-center gap-3">
          <span class="font-mono font-semibold text-xl text-primary">{{ policy()?.policy_code }}</span>
          <span class="font-mono text-sm bg-muted px-2 py-1 rounded">v{{ policy()?.version }}</span>
        </div>
        <div class="flex flex-wrap gap-2">
          <z-badge [zType]="getCategoryBadgeType(policy()!.category)">
            {{ policy()?.category }}
          </z-badge>
          <z-badge [zType]="getStatusBadgeType(policy()!.status)">
            {{ policy()?.status }}
          </z-badge>
          <z-badge zType="default" *ngIf="policy()?.requires_acknowledgment">
            <z-icon zType="check-square" class="w-3 h-3 mr-1" />
            Requires Acknowledgment
          </z-badge>
          <z-badge zType="destructive" *ngIf="isExpired()">
            <z-icon zType="clock" class="w-3 h-3 mr-1" />
            Expired
          </z-badge>
        </div>
      </div>

      <!-- Title -->
      <h1 class="text-3xl font-bold text-foreground mb-4">{{ policy()?.title }}</h1>

      <!-- Description -->
      <p class="text-muted-foreground text-lg mb-6" *ngIf="policy()?.description">
        {{ policy()?.description }}
      </p>

      <!-- Meta Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 bg-muted/30 rounded-lg">
        <div class="flex items-start gap-3" *ngIf="policy()?.author">
          <z-icon zType="user" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Author</div>
            <div class="text-foreground">{{ policy()?.author?.full_name }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3" *ngIf="policy()?.effective_from">
          <z-icon zType="calendar" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Effective From</div>
            <div class="text-foreground">{{ policy()?.effective_from | date:'MMM dd, yyyy' }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3" *ngIf="policy()?.review_date">
          <z-icon zType="calendar-plus" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Review Date</div>
            <div class="text-foreground">{{ policy()?.review_date | date:'MMM dd, yyyy' }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3" *ngIf="policy()?.expires_at">
          <z-icon zType="clock" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Expires</div>
            <div class="text-foreground">{{ policy()?.expires_at | date:'MMM dd, yyyy' }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3" *ngIf="policy()?.approved_by && policy()?.approver">
          <z-icon zType="badge-check" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Approved By</div>
            <div class="text-foreground">{{ policy()?.approver?.full_name }}</div>
          </div>
        </div>
        <div class="flex items-start gap-3" *ngIf="policy()?.approved_at">
          <z-icon zType="calendar" class="w-5 h-5 text-muted-foreground mt-0.5" />
          <div>
            <div class="font-semibold text-sm text-muted-foreground">Approved On</div>
            <div class="text-foreground">{{ policy()?.approved_at | date:'MMM dd, yyyy' }}</div>
          </div>
        </div>
      </div>

      <!-- Version History -->
      <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg" *ngIf="policy()?.parent">
        <div class="flex items-center gap-2 text-blue-800 dark:text-blue-200">
          <z-icon zType="info" class="w-5 h-5" />
          <span>
            This is version {{ policy()?.version }}, updated from
            <a
              [routerLink]="['/communication/policies', policy()?.parent?.id]"
              class="underline font-semibold hover:text-blue-600"
            >
              {{ policy()?.parent?.policy_code }} v{{ policy()?.parent?.version }}
            </a>
          </span>
        </div>
      </div>

      <!-- Content -->
      <div class="mb-6">
        <h4 class="text-xl font-semibold text-foreground mb-4">Policy Content</h4>
        <div class="prose max-w-none">
          <div [innerHTML]="policy()?.content"></div>
        </div>
      </div>

      <!-- File Attachment -->
      <div class="mb-6 p-4 bg-muted/30 rounded-lg flex items-center justify-between gap-4" *ngIf="policy()?.file_url">
        <div class="flex items-center gap-3">
          <z-icon zType="file-text" class="w-8 h-8 text-primary" />
          <div>
            <div class="font-semibold text-foreground">Policy Document</div>
            <small class="text-sm text-muted-foreground">
              {{ policy()?.file_size ? (policy()?.file_size! / 1024 / 1024).toFixed(2) + ' MB' : 'Size unknown' }}
            </small>
          </div>
        </div>
        <button z-button zType="default" zSize="sm" (click)="downloadPolicy()" class="flex items-center gap-2">
          <z-icon zType="download" class="w-4 h-4" />
          Download
        </button>
      </div>

      <!-- Statistics -->
      <div class="grid grid-cols-2 gap-4 p-4 bg-muted/30 rounded-lg">
        <div class="flex items-center gap-3">
          <z-icon zType="eye" class="w-6 h-6 text-primary" />
          <div>
            <div class="text-2xl font-bold text-foreground">{{ policy()?.view_count || 0 }}</div>
            <div class="text-sm text-muted-foreground">Views</div>
          </div>
        </div>
        <div class="flex items-center gap-3" *ngIf="policy()?.requires_acknowledgment">
          <z-icon zType="check-circle" class="w-6 h-6 text-green-600" />
          <div>
            <div class="text-2xl font-bold text-foreground">{{ policy()?.acknowledgment_count || 0 }}</div>
            <div class="text-sm text-muted-foreground">Acknowledged</div>
          </div>
        </div>
      </div>
    </z-card>

    <!-- Acknowledgment Section -->
    <z-card class="mb-6" *ngIf="policy()?.requires_acknowledgment && !hasAcknowledged()">
      <div class="bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-4">
        <div class="flex items-center gap-2 text-blue-800 dark:text-blue-200">
          <z-icon zType="info" class="w-5 h-5" />
          <span>This policy requires your acknowledgment</span>
        </div>
      </div>
      <button
        z-button
        zType="default"
        (click)="acknowledgePolicy()"
        [disabled]="acknowledging()"
        class="w-full flex items-center justify-center gap-2 text-lg py-6"
      >
        <z-icon *ngIf="!acknowledging()" zType="check-circle" class="w-5 h-5" />
        <z-icon *ngIf="acknowledging()" zType="loader-circle" class="w-5 h-5 animate-spin" />
        {{ acknowledging() ? 'Acknowledging...' : 'Acknowledge Policy' }}
      </button>
    </z-card>

    <!-- Acknowledged Message -->
    <z-card class="mb-6 bg-green-50 dark:bg-green-950 border-green-500" *ngIf="hasAcknowledged()">
      <div class="flex items-center gap-2 text-green-800 dark:text-green-200">
        <z-icon zType="check-circle" class="w-5 h-5" />
        <span class="font-semibold">You have acknowledged this policy</span>
      </div>
    </z-card>

    <!-- Statistics Card (Admin/Manager) -->
    <z-card *ngIf="canViewStatistics() && statistics()">
      <h4 class="text-xl font-semibold text-foreground mb-6 flex items-center gap-2">
        <z-icon zType="bar-chart" class="w-6 h-6" />
        Acknowledgment Statistics
      </h4>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="p-6 bg-primary/5 rounded-lg border border-primary/20">
          <div class="text-3xl font-bold text-primary mb-1">{{ statistics()?.total_views }}</div>
          <div class="text-sm text-muted-foreground mb-2">Total Views</div>
          <div class="text-lg font-semibold text-foreground">{{ statistics()?.view_percentage }}%</div>
        </div>

        <div class="p-6 bg-green-50 dark:bg-green-950 rounded-lg border border-green-200 dark:border-green-800" *ngIf="policy()?.requires_acknowledgment">
          <div class="text-3xl font-bold text-green-600 dark:text-green-400 mb-1">{{ statistics()?.total_acknowledgments }}</div>
          <div class="text-sm text-muted-foreground mb-2">Acknowledged</div>
          <div class="text-lg font-semibold text-foreground">{{ statistics()?.acknowledgment_percentage }}%</div>
        </div>

        <div class="p-6 bg-muted/50 rounded-lg border border-border">
          <div class="text-3xl font-bold text-foreground mb-1">{{ statistics()?.total_employees }}</div>
          <div class="text-sm text-muted-foreground">Total Employees</div>
        </div>
      </div>

      <!-- Acknowledgments Table -->
      <div *ngIf="statistics()?.acknowledgments && statistics()!.acknowledgments.length > 0">
        <h5 class="text-lg font-semibold text-foreground mb-4">Acknowledgment Details</h5>
        <div class="overflow-x-auto">
          <table z-table>
            <thead>
              <tr>
                <th>Employee</th>
                <th>Viewed At</th>
                <th>Acknowledged At</th>
                <th>Policy Version</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let ack of statistics()?.acknowledgments">
                <td class="font-medium">{{ ack.employee?.full_name || 'Unknown' }}</td>
                <td>{{ ack.viewed_at | date:'MMM dd, yyyy h:mm a' }}</td>
                <td>
                  <z-badge zType="default" *ngIf="ack.acknowledged_at">
                    {{ ack.acknowledged_at | date:'MMM dd, yyyy h:mm a' }}
                  </z-badge>
                  <z-badge zType="secondary" *ngIf="!ack.acknowledged_at">
                    Not Acknowledged
                  </z-badge>
                </td>
                <td>
                  <span class="font-mono text-sm bg-muted px-2 py-1 rounded">v{{ ack.policy_version }}</span>
                </td>
                <td>
                  <span class="text-sm text-muted-foreground">{{ ack.comments || '-' }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </z-card>

    <!-- Related Versions -->
    <z-card *ngIf="policy()?.versions && (policy()?.versions?.length ?? 0) > 0" class="mt-6">
      <h4 class="text-xl font-semibold text-foreground mb-6 flex items-center gap-2">
        <z-icon zType="clock" class="w-6 h-6" />
        Policy Versions
      </h4>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div *ngFor="let version of policy()?.versions" class="p-4 bg-muted/30 rounded-lg border border-border">
          <div class="flex items-center justify-between mb-3">
            <span class="font-mono text-sm bg-muted px-2 py-1 rounded">v{{ version.version }}</span>
            <z-badge [zType]="getStatusBadgeType(version.status)">{{ version.status }}</z-badge>
          </div>
          <div class="font-semibold text-foreground mb-2">{{ version.title }}</div>
          <div class="flex items-center gap-2 text-sm text-muted-foreground mb-3">
            <z-icon zType="calendar" class="w-4 h-4" />
            <span>{{ version.created_at | date:'MMM dd, yyyy' }}</span>
          </div>
          <a
            [routerLink]="['/communication/policies', version.id]"
            z-button
            zType="outline"
            zSize="sm"
            class="w-full"
          >
            View Version
          </a>
        </div>
      </div>
    </z-card>
  </div>
</div>
