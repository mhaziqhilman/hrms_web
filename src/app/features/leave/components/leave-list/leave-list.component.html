<div class="bg-background min-h-screen">
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-foreground">Leave Management</h1>
      <p class="text-muted-foreground">View and track all leave applications</p>
    </div>
    <div class="flex gap-2">
      <button z-button zType="outline" routerLink="/leave/balance" class="gap-2">
        <z-icon zType="activity" class="w-4 h-4" />
        View Balance
      </button>
      <button z-button zType="outline" routerLink="/leave/approvals" class="gap-2">
        <z-icon zType="circle-check" class="w-4 h-4" />
        Approvals
      </button>
      <button z-button routerLink="/leave/apply" class="gap-2">
        <z-icon zType="plus" class="w-4 h-4" />
        Apply Leave
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="flex items-center gap-3 mb-6 flex-wrap justify-between">
    <div class="flex items-center gap-3 flex-1 flex-wrap">
      <!-- Status Filter -->
      <div z-menu [zMenuTriggerFor]="statusMenu">
        <button
          z-button
          zType="outline"
          [class]="selectedStatus()
            ? 'gap-2 border border-solid px-2 bg-primary/5 text-primary border-primary'
            : 'gap-2 border border-dashed px-2'">
          <z-icon [zType]="selectedStatus() ? 'circle-check' : 'circle-plus'" class="w-4 h-4" />
          {{ getStatusDisplayName() }}
        </button>
      </div>
      <ng-template #statusMenu>
        <div z-menu-content class="w-48">
          <button type="button" z-menu-item (click)="selectedStatus.set(''); onFilterChange()">
            All Status
          </button>
          <button type="button" z-menu-item (click)="selectedStatus.set(LeaveStatus.PENDING); onFilterChange()">
            Pending
          </button>
          <button type="button" z-menu-item (click)="selectedStatus.set(LeaveStatus.APPROVED); onFilterChange()">
            Approved
          </button>
          <button type="button" z-menu-item (click)="selectedStatus.set(LeaveStatus.REJECTED); onFilterChange()">
            Rejected
          </button>
          <button type="button" z-menu-item (click)="selectedStatus.set(LeaveStatus.CANCELLED); onFilterChange()">
            Cancelled
          </button>
        </div>
      </ng-template>

      <!-- Start Date Filter -->
      <z-date-picker
        placeholder="From Date"
        zFormat="dd-MM-yyyy"
        [(ngModel)]="startDateValue"
        (dateChange)="onStartDateChange($event)"
        [class]="startDateFilter() ? 'has-value' : ''">
      </z-date-picker>

      <!-- End Date Filter -->
      <z-date-picker
        placeholder="To Date"
        zFormat="dd-MM-yyyy"
        [(ngModel)]="endDateValue"
        (dateChange)="onEndDateChange($event)"
        [class]="endDateFilter() ? 'has-value' : ''">
      </z-date-picker>

      <!-- Clear Filters -->
      <button
        *ngIf="selectedStatus() || startDateFilter() || endDateFilter()"
        type="button"
        z-button
        zType="outline"
        class="gap-2 border-none shadow-none px-2"
        (click)="clearFilters()">
        Reset
        <z-icon zType="x" class="w-4 h-4" />
      </button>
    </div>

    <!-- Column Toggle - Right Side -->
    <div z-menu [zMenuTriggerFor]="columnMenu">
      <button z-button zType="outline" class="gap-2 px-2">
        <z-icon zType="eye" class="w-4 h-4" />
        View
      </button>
    </div>
    <ng-template #columnMenu>
      <div z-menu-content class="w-56">
        <div class="px-2 py-1.5 text-xs font-semibold text-muted-foreground">
          Toggle Columns
        </div>
        @for (column of columnList; track column.key) {
          <button type="button" z-menu-item (click)="toggleColumn(column.key)" class="justify-between">
            {{ column.label }}
            @if (visibleColumns()[column.key]) {
              <z-icon zType="check" class="w-4 h-4" />
            } @else {
              <span class="w-4 h-4"></span>
            }
          </button>
        }
      </div>
    </ng-template>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="flex items-center justify-center py-20">
      <z-icon zType="loader-circle" class="w-8 h-8 animate-spin text-primary" />
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-2 text-red-800 mb-6">
      <z-icon zType="triangle-alert" class="w-5 h-5" />
      <span>{{ error() }}</span>
    </div>
  }

  <!-- Bulk Actions Bar - Modern SaaS Style -->
  @if (getSelectedCount() > 0) {
    <div class="mb-4 bg-gradient-to-r from-primary/5 via-primary/10 to-primary/5 backdrop-blur-sm border-l-4 border-primary shadow-sm">
      <div class="flex items-center justify-between px-6 py-3 gap-4">
        <!-- Left: Selection Info -->
        <div class="flex items-center gap-3">
          <div class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/20">
            <z-icon zType="check-circle" class="w-4 h-4 text-primary" />
          </div>
          <div class="flex flex-col">
            <span class="text-sm font-semibold text-foreground">{{ getSelectedCount() }} Selected</span>
            <span class="text-xs text-muted-foreground">Bulk actions available</span>
          </div>
        </div>

        <!-- Right: Action Buttons -->
        <div class="flex items-center gap-2">
          <button type="button" (click)="bulkApprove()"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 rounded-md transition-all duration-200 shadow-sm hover:shadow-md">
            <z-icon zType="circle-check" class="w-4 h-4" />
            <span>Approve</span>
          </button>
          <button type="button" (click)="bulkReject()"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-destructive hover:bg-destructive/90 rounded-md transition-all duration-200 shadow-sm hover:shadow-md">
            <z-icon zType="circle-x" class="w-4 h-4" />
            <span>Reject</span>
          </button>
          <div class="w-px h-6 bg-border mx-1"></div>
          <button type="button" (click)="clearSelection()"
            class="inline-flex items-center gap-1.5 px-3 py-2 text-sm font-medium text-muted-foreground hover:text-foreground transition-colors duration-200">
            <z-icon zType="x" class="w-4 h-4" />
            <span>Clear</span>
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Table -->
  @if (!loading() && !error()) {
    <div class="leave-table-container rounded-lg border" *ngIf="leaves().length > 0">
      <table z-table class="leave-table">
        <thead>
          <tr>
            <!-- Checkbox Column -->
            <th class="!pl-3 w-10 th-text-center">
              <span z-checkbox class="border-primary/30" [(ngModel)]="selectAll" (ngModelChange)="toggleSelectAll()"></span>
            </th>

            <!-- Employee Column - Sortable -->
            <th class="!pl-3" *ngIf="visibleColumns()['employee']">
              <button
                (click)="onSort('employee')"
                class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                [class.text-primary]="isSortActive('employee')">
                <span>Employee</span>
                <z-icon [zType]="getSortIcon('employee')" class="w-4 h-4" />
              </button>
            </th>

            <!-- Leave Type Column - Sortable -->
            <th *ngIf="visibleColumns()['leaveType']">
              <button
                (click)="onSort('leaveType')"
                class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                [class.text-primary]="isSortActive('leaveType')">
                <span>Leave Type</span>
                <z-icon [zType]="getSortIcon('leaveType')" class="w-4 h-4" />
              </button>
            </th>

            <!-- Start Date Column - Sortable -->
            <th *ngIf="visibleColumns()['startDate']">
              <button
                (click)="onSort('startDate')"
                class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                [class.text-primary]="isSortActive('startDate')">
                <span>Start Date</span>
                <z-icon [zType]="getSortIcon('startDate')" class="w-4 h-4" />
              </button>
            </th>

            <!-- End Date Column - Sortable -->
            <th *ngIf="visibleColumns()['endDate']">
              <button
                (click)="onSort('endDate')"
                class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                [class.text-primary]="isSortActive('endDate')">
                <span>End Date</span>
                <z-icon [zType]="getSortIcon('endDate')" class="w-4 h-4" />
              </button>
            </th>

            <!-- Duration Column - Sortable -->
            <th *ngIf="visibleColumns()['duration']">
              <button
                (click)="onSort('duration')"
                class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                [class.text-primary]="isSortActive('duration')">
                <span>Duration</span>
                <z-icon [zType]="getSortIcon('duration')" class="w-4 h-4" />
              </button>
            </th>

            <!-- Status Column - Sortable -->
            <th *ngIf="visibleColumns()['status']">
              <button
                (click)="onSort('status')"
                class="flex items-center gap-2 hover:text-primary transition-colors cursor-pointer"
                [class.text-primary]="isSortActive('status')">
                <span>Status</span>
                <z-icon [zType]="getSortIcon('status')" class="w-4 h-4" />
              </button>
            </th>

            <!-- Actions Column -->
            <th class="!pr-3">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (leave of leaves(); track leave.id) {
            <tr>
              <!-- Checkbox -->
              <!-- <td class="!pl-3 text-center">
                <input
                  type="checkbox"
                  [checked]="isLeaveSelected(leave.id)"
                  (change)="toggleLeaveSelection(leave.id)"
                  class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary cursor-pointer" />
              </td> -->

              <td class="!pl-3 text-center">
                <span z-checkbox [ngModel]="isLeaveSelected(leave.id)"
                  (ngModelChange)="toggleLeaveSelection(leave.id)"
                  class="border-primary/30"></span>
              </td>

              <!-- Employee -->
              @if (visibleColumns()['employee']) {
                <td class="!pl-3">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                      <z-icon zType="user" class="w-5 h-5 text-primary" />
                    </div>
                    <div class="min-w-0">
                      <div class="text-sm font-medium text-foreground">{{ leave.employee?.full_name }}</div>
                      <div class="text-xs text-muted-foreground">{{ leave.employee?.employee_id }}</div>
                    </div>
                  </div>
                </td>
              }

              <!-- Leave Type -->
              @if (visibleColumns()['leaveType']) {
                <td>
                  <div class="text-sm text-foreground">{{ leave.leave_type?.name || 'N/A' }}</div>
                  <div class="text-xs text-muted-foreground">{{ leave.leave_type?.is_paid ? 'Paid' : 'Unpaid' }}</div>
                </td>
              }

              <!-- Start Date -->
              @if (visibleColumns()['startDate']) {
                <td>{{ formatDate(leave.start_date) }}</td>
              }

              <!-- End Date -->
              @if (visibleColumns()['endDate']) {
                <td>{{ formatDate(leave.end_date) }}</td>
              }

              <!-- Duration -->
              @if (visibleColumns()['duration']) {
                <td>
                  <div class="text-sm font-medium text-foreground">{{ getDuration(leave) }}</div>
                </td>
              }

              <!-- Status -->
              @if (visibleColumns()['status']) {
                <td>
                  <z-badge [zType]="getStatusBadgeType(leave.status)" zShape="pill" class="gap-1">
                    <z-icon [zType]="getStatusIconType(leave.status)" class="w-3 h-3" />
                    {{ leave.status }}
                  </z-badge>
                </td>
              }

              <!-- Actions -->
              <td class="!pr-3 text-right">
                <div class="flex gap-2 flex-nowrap justify-end">
                  <button
                    type="button"
                    z-button
                    zType="outline"
                    zSize="sm"
                    (click)="viewLeaveDetails(leave)"
                    [zTooltip]="'View'">
                    <z-icon zType="eye" class="w-4 h-4" />
                  </button>
                  @if (canEdit(leave)) {
                    <a
                      [routerLink]="['/leave', leave.id, 'edit']"
                      z-button
                      zType="outline"
                      zSize="sm"
                      [zTooltip]="'Edit'">
                      <z-icon zType="pencil" class="w-4 h-4" />
                    </a>
                  }
                  @if (canApprove(leave)) {
                    <button
                      type="button"
                      (click)="approveLeave(leave)"
                      z-button
                      zType="outline"
                      zSize="sm"
                      [zTooltip]="'Approve'"
                      class="text-green-600 hover:text-green-700">
                      <z-icon zType="circle-check" class="w-4 h-4" />
                    </button>
                  }
                  @if (canReject(leave)) {
                    <button
                      type="button"
                      (click)="rejectLeave(leave)"
                      z-button
                      zType="outline"
                      zSize="sm"
                      [zTooltip]="'Reject'"
                      class="text-red-600 hover:text-red-700">
                      <z-icon zType="circle-x" class="w-4 h-4" />
                    </button>
                  }
                  @if (canCancel(leave)) {
                    <button
                      type="button"
                      (click)="cancelLeave(leave)"
                      z-button
                      zType="outline"
                      zSize="sm"
                      [zTooltip]="'Cancel'"
                      class="text-orange-600 hover:text-orange-700">
                      <z-icon zType="ban" class="w-4 h-4" />
                    </button>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Empty State -->
    @if (leaves().length === 0) {
      <div class="bg-card border rounded-lg">
        <div class="flex flex-col items-center justify-center py-20 text-center">
          <z-icon zType="inbox" class="w-16 h-16 text-muted-foreground mb-4" />
          <h3 class="text-lg font-semibold mb-2">No Leave Applications Found</h3>
          <p class="text-muted-foreground mb-4">No leave applications match your current filters.</p>
          <button z-button zType="outline" (click)="clearFilters()">
            Clear Filters
          </button>
        </div>
      </div>
    }

    <!-- Pagination -->
    @if (leaves().length > 0) {
      <div class="flex items-center justify-between mt-4">
        <div class="text-sm text-muted-foreground">
          Showing {{ (currentPage() - 1) * limit() + 1 }} to
          {{ Math.min(currentPage() * limit(), total()) }} of
          {{ total() }} records
        </div>
        <div class="flex items-center gap-1">
          <button
            z-button
            zType="outline"
            zSize="sm"
            (click)="onPageChange(currentPage() - 1)"
            [disabled]="currentPage() === 1">
            Previous
          </button>
          @for (page of [].constructor(Math.min(totalPages(), 5)); track $index) {
            <button
              z-button
              [zType]="currentPage() === $index + 1 ? 'default' : 'outline'"
              zSize="sm"
              (click)="onPageChange($index + 1)"
              class="min-w-[36px]">
              {{ $index + 1 }}
            </button>
          }
          <button
            z-button
            zType="outline"
            zSize="sm"
            (click)="onPageChange(currentPage() + 1)"
            [disabled]="currentPage() === totalPages()">
            Next
          </button>
        </div>
      </div>
    }
  }
</div>
