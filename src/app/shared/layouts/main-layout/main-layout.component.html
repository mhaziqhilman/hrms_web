<z-layout class="h-screen">
  <!-- Sidebar -->
  <z-sidebar [zWidth]="250" [zCollapsedWidth]="70" [zCollapsible]="true" [zCollapsed]="sidebarCollapsed()"
    (zCollapsedChange)="onSidebarCollapsedChange($event)" class="p-0! h-screen">
    <nav class="flex h-full flex-col">
      <!-- Company Switcher -->
      <div [class]="'flex-shrink-0 border-b ' + (sidebarCollapsed() ? 'p-2' : 'p-3')">
        @if (currentCompany || isSuperAdmin) {
          <div z-menu #companyMenuTrigger="zMenu" [zMenuTriggerFor]="companyMenu" zPlacement="bottomLeft"
            (zMenuOpened)="companyMenuOpen = true" (zMenuClosed)="companyMenuOpen = false"
            data-company-trigger [class]="
              'hover:bg-accent flex cursor-pointer items-center rounded-md transition-colors ' +
              (sidebarCollapsed() ? 'justify-center p-1.5' : 'gap-2.5 p-2')
            ">
            <!-- Company Icon / Logo -->
            @if (currentCompany?.logo_url?.startsWith?.('http')) {
              <img [src]="currentCompany!.logo_url"
                [alt]="currentCompany!.name"
                [class]="'flex-shrink-0 rounded-md object-cover ' +
                  (sidebarCollapsed() ? 'w-8 h-8' : 'w-9 h-9')" />
            } @else {
              <div [class]="'flex-shrink-0 rounded-md bg-primary/10 flex items-center justify-center font-semibold text-primary ' +
                (sidebarCollapsed() ? 'w-8 h-8 text-xs' : 'w-9 h-9 text-sm')">
                {{ currentCompany ? getCompanyInitials() : 'SA' }}
              </div>
            }

            @if (!sidebarCollapsed()) {
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-sm truncate leading-tight">{{ currentCompany?.name || 'Select Company' }}</div>
                <div class="text-xs text-muted-foreground truncate capitalize">{{ getDisplayRole() }}</div>
              </div>
              <z-icon zType="chevrons-up-down" class="ml-auto shrink-0 w-4 h-4 text-muted-foreground" />
            }
          </div>

          <ng-template #companyMenu>
            <div z-menu-content class="w-64 max-h-80 overflow-y-auto">
              @if (isSuperAdmin) {
                <!-- Super Admin: show ALL companies with clear context option -->
                <div class="px-2 py-1.5">
                  <p class="text-xs font-medium text-muted-foreground">Company Context</p>
                </div>
                <button type="button" z-menu-item class="justify-between"
                  (click)="clearCompanyContext()"
                  [disabled]="switchingCompany">
                  <div class="flex items-center gap-2 min-w-0">
                    <div class="w-6 h-6 rounded bg-muted flex items-center justify-center text-[10px] font-semibold text-muted-foreground flex-shrink-0">
                      <z-icon zType="globe" class="w-3.5 h-3.5" />
                    </div>
                    <div class="min-w-0">
                      <div class="text-sm truncate">All Companies</div>
                    </div>
                  </div>
                  @if (!currentCompany) {
                    <z-icon zType="check" class="w-4 h-4 text-primary ml-2 flex-shrink-0" />
                  }
                </button>
                <z-divider zSpacing="sm" />
                @for (company of allCompanies; track company.id) {
                  <button type="button" z-menu-item class="justify-between"
                    (click)="switchCompany(company.id)"
                    [disabled]="switchingCompany">
                    <div class="flex items-center gap-2 min-w-0">
                      @if (company.logo_url?.startsWith?.('http')) {
                        <img [src]="company.logo_url" [alt]="company.name"
                          class="w-6 h-6 rounded object-cover flex-shrink-0" />
                      } @else {
                        <div class="w-6 h-6 rounded bg-primary/10 flex items-center justify-center text-[10px] font-semibold text-primary flex-shrink-0">
                          {{ getCompanyInitials(company.name) }}
                        </div>
                      }
                      <div class="min-w-0">
                        <div class="text-sm truncate">{{ company.name }}</div>
                      </div>
                    </div>
                    @if (company.id === currentCompany?.id) {
                      <z-icon zType="check" class="w-4 h-4 text-primary ml-2 flex-shrink-0" />
                    }
                  </button>
                }
              } @else {
                <!-- Regular users: show memberships -->
                <div class="px-2 py-1.5">
                  <p class="text-xs font-medium text-muted-foreground">Your Companies</p>
                </div>
                @for (membership of companyMemberships; track membership.id) {
                  <button type="button" z-menu-item class="justify-between"
                    (click)="switchCompany(membership.company_id)"
                    [disabled]="switchingCompany">
                    <div class="flex items-center gap-2 min-w-0">
                      @if (membership.company?.logo_url?.startsWith?.('http')) {
                        <img [src]="membership.company!.logo_url" [alt]="membership.company!.name"
                          class="w-6 h-6 rounded object-cover flex-shrink-0" />
                      } @else {
                        <div class="w-6 h-6 rounded bg-primary/10 flex items-center justify-center text-[10px] font-semibold text-primary flex-shrink-0">
                          {{ getCompanyInitials(membership.company?.name) }}
                        </div>
                      }
                      <div class="min-w-0">
                        <div class="text-sm truncate">{{ membership.company?.name }}</div>
                        <div class="text-[11px] text-muted-foreground truncate capitalize">{{ membership.role }}</div>
                      </div>
                    </div>
                    @if (membership.company_id === currentCompany?.id) {
                      <z-icon zType="check" class="w-4 h-4 text-primary ml-2 flex-shrink-0" />
                    }
                  </button>
                }
              }
            </div>
          </ng-template>
        } @else {
          <!-- Fallback: No company assigned -->
          <div [class]="'flex items-center rounded-md ' + (sidebarCollapsed() ? 'justify-center p-1.5' : 'gap-2.5 p-2')">
            <div [class]="'flex-shrink-0 rounded-md bg-muted flex items-center justify-center font-semibold text-muted-foreground ' +
              (sidebarCollapsed() ? 'w-8 h-8 text-xs' : 'w-9 h-9 text-sm')">
              <z-icon [zType]="$any('building')" class="w-4 h-4" />
            </div>
            @if (!sidebarCollapsed()) {
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-sm truncate leading-tight text-muted-foreground">No Company</div>
                <div class="text-xs text-muted-foreground truncate">Not assigned</div>
              </div>
            }
          </div>
        }
      </div>

      <!-- Scrollable Menu Section -->
      <div
        [class]="'scrollbar-custom flex-1 flex flex-col overflow-y-auto overflow-x-hidden' + (sidebarCollapsed() ? 'gap-1 p-1 pt-4' : 'gap-4 py-4 pl-4 pr-3')">
        <!-- Dashboards Group -->
        <z-sidebar-group>
          @if (!sidebarCollapsed()) {
          <z-sidebar-group-label>Dashboards</z-sidebar-group-label>
          }
          @for (item of menuGroups[0].items; track item.route) {
          @if (isItemVisible(item)) {
          <a [routerLink]="item.route" routerLinkActive="bg-primary/10 text-primary font-semibold" z-button
            zType="ghost" class="px-2 py-0"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? item.title : ''" zPosition="right">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-1'" />
            @if (!sidebarCollapsed()) {
            <span>{{ item.title }}</span>
            }
          </a>
          }
          }
        </z-sidebar-group>

        <!-- HR Management Group -->
        @if (isGroupVisible(menuGroups[1])) {
        <z-sidebar-group>
          @if (!sidebarCollapsed()) {
          <z-sidebar-group-label>HR Management</z-sidebar-group-label>
          }
          @for (item of menuGroups[1].items; track item.title) {
          @if (item.children && item.children.length > 0) {
          <!-- Parent item with children -->
          <button type="button" z-button zType="ghost" class="px-2 py-1"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? item.title : ''" zPosition="right" (click)="toggleMenuItem(item.title)">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-1'" />
            @if (!sidebarCollapsed()) {
            <span class="flex-1 text-left">{{ item.title }}</span>
            <z-icon [zType]="isMenuItemExpanded(item.title) ? 'chevron-up' : 'chevron-down'" class="ml-auto w-4 h-4" />
            }
          </button>

          <!-- Children items -->
          @if (isMenuItemExpanded(item.title) && !sidebarCollapsed()) {
          <div class="ml-4 space-y-1 border-l-1 px-2.5">
            @for (child of item.children; track child.route) {
            <a [routerLink]="child.route" routerLinkActive="bg-primary/10 text-primary font-semibold"
              [routerLinkActiveOptions]="{ exact: !child.children }" z-button zType="ghost"
              class="justify-start w-full pl-2 px-2 py-0">
              <z-icon [zType]="child.icon" class="mr-1 w-4 h-4" />
              <span>{{ child.title }}</span>
            </a>
            }
          </div>
          }
          } @else {
          <!-- Regular item without children -->
          <a [routerLink]="item.route" routerLinkActive="bg-primary/10 text-primary font-semibold" z-button
            zType="ghost" class="px-2 py-1"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? item.title : ''" zPosition="right">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-1'" />
            @if (!sidebarCollapsed()) {
            <span>{{ item.title }}</span>
            }
          </a>
          }
          }
        </z-sidebar-group>
        }

        <!-- Personal Group -->
        <z-sidebar-group>
          @if (!sidebarCollapsed()) {
          <z-sidebar-group-label>Personal</z-sidebar-group-label>
          }
          @for (item of menuGroups[2].items; track item.title) {
          @if (isItemVisible(item)) {
          <a [routerLink]="item.route" routerLinkActive="bg-primary/10 text-primary font-semibold" z-button
            zType="ghost" class="px-2 py-1"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? getDisplayTitle(item.title) : ''" zPosition="right">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-2'" />
            @if (!sidebarCollapsed()) {
            <span>{{ getDisplayTitle(item.title) }}</span>
            }
          </a>
          }
          }
        </z-sidebar-group>

        <!-- Administration Group -->
        @if (isGroupVisible(menuGroups[3])) {
        <z-sidebar-group>
          @if (!sidebarCollapsed()) {
          <z-sidebar-group-label>Administration</z-sidebar-group-label>
          }
          @for (item of menuGroups[3].items; track item.title) {
          @if (isItemVisible(item)) {
          @if (item.children && item.children.length > 0) {
          <button type="button" z-button zType="ghost" class="px-2 py-1"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? item.title : ''" zPosition="right" (click)="toggleMenuItem(item.title)">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-1'" />
            @if (!sidebarCollapsed()) {
            <span class="flex-1 text-left">{{ item.title }}</span>
            <z-icon [zType]="isMenuItemExpanded(item.title) ? 'chevron-up' : 'chevron-down'" class="ml-auto w-4 h-4" />
            }
          </button>

          @if (isMenuItemExpanded(item.title) && !sidebarCollapsed()) {
          <div class="ml-4 space-y-1 border-l-1 px-2.5">
            @for (child of item.children; track child.route) {
            <a [routerLink]="child.route" routerLinkActive="bg-primary/10 text-primary font-semibold"
              [routerLinkActiveOptions]="{ exact: !child.children }" z-button zType="ghost"
              class="justify-start w-full pl-2 px-2 py-0">
              <z-icon [zType]="child.icon" class="mr-1 w-4 h-4" />
              <span>{{ child.title }}</span>
            </a>
            }
          </div>
          }
          } @else {
          <a [routerLink]="item.route" routerLinkActive="bg-primary/10 text-primary font-semibold" z-button
            zType="ghost" class="px-2 py-1"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? item.title : ''" zPosition="right">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-2'" />
            @if (!sidebarCollapsed()) {
            <span>{{ item.title }}</span>
            }
          </a>
          }
          }
          }
        </z-sidebar-group>
        }

        <!-- Systems Group -->
        <z-sidebar-group>
          @if (!sidebarCollapsed()) {
          <z-sidebar-group-label>Systems</z-sidebar-group-label>
          }
          @for (item of menuGroups[4].items; track item.title) {
          @if (isItemVisible(item)) {
          @if (item.children && item.children.length > 0) {
          <button type="button" z-button zType="ghost" class="px-2 py-1"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? item.title : ''" zPosition="right" (click)="toggleMenuItem(item.title)">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-1'" />
            @if (!sidebarCollapsed()) {
            <span class="flex-1 text-left">{{ item.title }}</span>
            <z-icon [zType]="isMenuItemExpanded(item.title) ? 'chevron-up' : 'chevron-down'" class="ml-auto w-4 h-4" />
            }
          </button>

          @if (isMenuItemExpanded(item.title) && !sidebarCollapsed()) {
          <div class="ml-4 space-y-1 border-l-1 px-2.5">
            @for (child of item.children; track child.route) {
            <a [routerLink]="child.route" routerLinkActive="bg-primary/10 text-primary font-semibold"
              [routerLinkActiveOptions]="{ exact: !child.children }" z-button zType="ghost"
              class="justify-start w-full pl-2 px-2 py-0">
              <z-icon [zType]="child.icon" class="mr-1 w-4 h-4" />
              <span>{{ child.title }}</span>
            </a>
            }
          </div>
          }
          } @else {
          <a [routerLink]="item.route" routerLinkActive="bg-primary/10 text-primary font-semibold" z-button
            zType="ghost" class="px-2 py-1"
            [class]="sidebarCollapsed() ? 'justify-center self-center !flex' : 'justify-start'"
            [zTooltip]="sidebarCollapsed() ? item.title : ''" zPosition="right">
            <z-icon [zType]="item.icon" [class]="sidebarCollapsed() ? '' : 'mr-2'" />
            @if (!sidebarCollapsed()) {
            <span>{{ item.title }}</span>
            }
          </a>
          }
          }
          }
        </z-sidebar-group>
      </div>

      <!-- Fixed Bottom User Profile Section -->
      <div [class]="'flex-shrink-0 border-t ' + (sidebarCollapsed() ? 'p-1' : 'p-4')">
        <div z-menu [zMenuTriggerFor]="userMenu" zPlacement="rightBottom" [class]="
            'hover:bg-accent flex cursor-pointer items-center rounded-md ' +
            (sidebarCollapsed() ? 'justify-center p-0' : 'gap-2 p-2')
          ">
          <z-avatar [zAlt]="currentUser?.employee?.full_name || 'User'" [zFallback]="getUserInitials()" zSize="sm" />

          @if (!sidebarCollapsed()) {
          <div class="flex-1 min-w-0">
            <div class="font-medium text-sm truncate">{{ getDisplayName() }}</div>
            <div class="text-xs text-muted-foreground truncate">{{ currentUser?.email || 'admin@hrms.com' }}</div>
          </div>
          <z-icon zType="chevrons-up-down" class="ml-auto shrink-0" />
          }
        </div>

        <ng-template #userMenu>
          <div z-menu-content class="w-48">
            <button type="button" z-menu-item>
              <z-icon zType="user" class="mr-2" />
              Profile
            </button>
            <button type="button" z-menu-item>
              <z-icon zType="settings" class="mr-2" />
              Settings
            </button>
            <z-divider zSpacing="sm" />
            <button type="button" z-menu-item (click)="logout()">
              <z-icon zType="log-out" class="mr-2" />
              Logout
            </button>
          </div>
        </ng-template>
      </div>
    </nav>
  </z-sidebar>

  <!-- Main Content Area -->
  <z-content class="!p-0 flex flex-col !overflow-hidden">
    <!-- Fixed Header -->
    <header class="flex-shrink-0 border-b bg-background">
      <div class="relative flex w-full h-full items-center px-4 lg:gap-4 justify-between">
        <!-- Left: Sidebar Toggle & Breadcrumb -->
        <div class="flex items-center gap-2 lg:gap-4 z-10">
          <a type="button" z-button zType="ghost" zSize="sm" (click)="toggleSidebar()">
            <z-icon zType="panel-left" />
          </a>
          <z-divider zOrientation="vertical" class="h-6 mx-0 hidden md:block" />

          <!-- Breadcrumb -->
          <div class="hidden md:block">
            <z-breadcrumb>
              <z-breadcrumb-item>
                <a routerLink="/dashboard">Home</a>
              </z-breadcrumb-item>
              @for (crumb of breadcrumbs(); track crumb.url) {
              <z-breadcrumb-item>
                @if ($last) {
                {{ crumb.label }}
                } @else {
                <a [routerLink]="crumb.url">{{ crumb.label }}</a>
                }
              </z-breadcrumb-item>
              }
            </z-breadcrumb>
          </div>
        </div>

        <!-- Center: Search Bar -->
        <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-sm hidden md:block">
          <div class="relative items-center">
            <z-icon zType="search"
              class="absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground z-10" />
            <input z-input type="search" placeholder="Search..."
              class="pl-11 pr-14 w-full h-9 text-sm rounded-xl shadow-sm" />
            <div
              class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none flex items-center gap-0.5 text-xs text-muted-foreground">
              <span>⌘</span>
              <span>+</span>
              <span>K</span>
            </div>
          </div>
        </div>

        <!-- Right: Action Icons -->
        <div class="flex items-center gap-2 ml-auto z-10">
          <!-- Messages -->
          <a type="button" z-button zType="ghost" zSize="sm" class="relative" [zTooltip]="'Messages'">
            <z-icon zType="mail" />
            <span
              class="absolute top-0 right-0 inline-flex items-center justify-center w-2 h-2 bg-destructive rounded-full"></span>
          </a>

          <!-- Notifications -->
          <a type="button" z-button zType="ghost" zSize="sm" class="relative" [zTooltip]="'Notifications'">
            <z-icon zType="bell" />
            <span
              class="absolute top-0 right-0 inline-flex items-center justify-center w-2 h-2 bg-destructive rounded-full"></span>
          </a>

          <!-- Dark Mode Toggle -->
          <button type="button" z-button zType="ghost" zSize="sm" class="relative"
            [zTooltip]="themeService.darkMode() ? 'Switch to light mode' : 'Switch to dark mode'"
            (click)="toggleTheme()">
            <z-icon zType="sun" class="rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
            <z-icon zType="moon"
              class="absolute inset-0 m-auto rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
          </button>
          <z-divider zOrientation="vertical" class="h-6 mx-0" />
          <!-- User Profile Menu -->
          <div z-menu [zMenuTriggerFor]="userMenuHeader" zPlacement="bottomRight">
            <button type="button" z-button zType="ghost" class="relative h-9 w-9 rounded-full p-0">
              <z-avatar class="h-8 w-8" [zAlt]="currentUser?.employee?.full_name || 'User'"
                [zFallback]="getUserInitials()" />
            </button>
          </div>

          <ng-template #userMenuHeader>
            <div z-menu-content class="w-56">
              <div class="flex items-center justify-start gap-2 p-2">
                <div class="flex flex-col space-y-1 leading-none">
                  <p class="font-medium text-sm">{{ currentUser?.employee?.full_name || 'Admin User' }}</p>
                  <p class="text-xs text-muted-foreground">{{ currentUser?.email || 'admin@hrms.com' }}</p>
                </div>
              </div>
              <z-divider zSpacing="sm" />
              <button type="button" z-menu-item>
                <z-icon zType="user" class="mr-2 w-4 h-4" />
                Profile
              </button>
              <button type="button" z-menu-item>
                <z-icon zType="settings" class="mr-2 w-4 h-4" />
                Settings
              </button>
              <z-divider zSpacing="sm" />
              <button type="button" z-menu-item (click)="logout()">
                <z-icon zType="log-out" class="mr-2 w-4 h-4" />
                Logout
              </button>
            </div>
          </ng-template>
        </div>
      </div>
    </header>

    <!-- Page Content -->
    <div class="flex-1 overflow-y-auto overflow-x-hidden p-8">
      <router-outlet></router-outlet>
    </div>

    <!-- Footer -->
    <z-footer class="flex-shrink-0 border-t bg-background">
      <div class="flex items-center justify-between h-14 px-6 text-sm text-muted-foreground">
        <div>
          <span class="font-semibold">2025 ©</span>
          <a href="#" class="hover:text-primary ml-1">HRMS</a>
        </div>
        <div class="hidden md:block">
          <span>Built with ZardUI & Tailwind CSS</span>
        </div>
      </div>
    </z-footer>
  </z-content>
</z-layout>